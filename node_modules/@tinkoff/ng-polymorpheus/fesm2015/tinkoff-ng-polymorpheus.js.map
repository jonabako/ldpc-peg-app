{"version":3,"file":"tinkoff-ng-polymorpheus.js","sources":["../../../projects/ng-polymorpheus/src/tokens/context.ts","../../../projects/ng-polymorpheus/src/classes/component.ts","../../../projects/ng-polymorpheus/src/directives/template.ts","../../../projects/ng-polymorpheus/src/classes/context.ts","../../../projects/ng-polymorpheus/src/directives/outlet.ts","../../../projects/ng-polymorpheus/src/polymorpheus.module.ts","../../../projects/ng-polymorpheus/src/public-api.ts","../../../projects/ng-polymorpheus/src/tinkoff-ng-polymorpheus.ts"],"sourcesContent":["import {InjectionToken} from '@angular/core';\n\n/**\n * Use this token to access context within your components when\n * instantiating them through {@link PolymorpheusOutletDirective}\n */\nexport const POLYMORPHEUS_CONTEXT = new InjectionToken<Record<any, any>>(\n    'POLYMORPHEUS_CONTEXT',\n);\n","import {Injector, Type} from '@angular/core';\nimport {POLYMORPHEUS_CONTEXT} from '../tokens/context';\n\n/**\n * Wrapper class for a component that will be used as content for {@link PolymorpheusOutletDirective}\n *\n * @param component — an Angular component to be dynamically created\n * @param injector — optional {@link Injector} for lazy loaded module case\n *\n * TODO: Remove second generic as it is irrelevant, remove `null` from injector type\n */\nexport class PolymorpheusComponent<T, _C = any> {\n    constructor(\n        readonly component: Type<T>,\n        private readonly i?: Injector | null,\n    ) {}\n\n    createInjector<C>(injector: Injector, useValue?: C): Injector {\n        return Injector.create({\n            parent: this.i || injector,\n            providers: [\n                {\n                    provide: POLYMORPHEUS_CONTEXT,\n                    useValue,\n                },\n            ],\n        });\n    }\n}\n","import {ChangeDetectorRef, Directive, Self, TemplateRef} from '@angular/core';\n\n/**\n * ng-template wrapper directive also stores {@link ChangeDetectorRef} to properly handle change detection.\n */\n@Directive({\n    selector: 'ng-template[polymorpheus]',\n    exportAs: 'polymorpheus',\n    inputs: ['polymorpheus'],\n})\nexport class PolymorpheusTemplate<C = any> {\n    polymorpheus: C | '' = '';\n\n    constructor(\n        @Self() readonly template: TemplateRef<C>,\n        private readonly cdr: ChangeDetectorRef,\n    ) {}\n\n    check(): void {\n        this.cdr.markForCheck();\n    }\n\n    static ngTemplateContextGuard<T>(\n        _dir: PolymorpheusTemplate<T>,\n        _ctx: any,\n    ): _ctx is T extends '' ? any : T {\n        return true;\n    }\n}\n","export class PolymorpheusContext<T> {\n    constructor(readonly $implicit: T) {}\n\n    get polymorpheusOutlet(): T {\n        return this.$implicit;\n    }\n}\n\n/**\n * @deprecated: use {@link PolymorpheusContext} instead\n * Primitive types used as content by {@link PolymorpheusOutletDirective}\n */\nexport class PrimitiveContext<T> extends PolymorpheusContext<T> {}\n","import {\n    ChangeDetectorRef,\n    ComponentFactoryResolver,\n    ComponentRef,\n    Directive,\n    DoCheck,\n    Injector,\n    OnChanges,\n    SimpleChanges,\n    TemplateRef,\n    ViewContainerRef,\n} from '@angular/core';\nimport {PolymorpheusComponent} from '../classes/component';\nimport {PolymorpheusContext} from '../classes/context';\nimport {PolymorpheusContent} from '../types/content';\nimport {PolymorpheusPrimitive} from '../types/primitive';\nimport {PolymorpheusTemplate} from './template';\n\n@Directive({\n    selector: '[polymorpheusOutlet]',\n    inputs: ['content: polymorpheusOutlet', 'context: polymorpheusOutletContext'],\n})\nexport class PolymorpheusOutletDirective<C> implements OnChanges, DoCheck {\n    private c?: ComponentRef<unknown>;\n\n    content: PolymorpheusContent<C> = '';\n    context?: C;\n\n    constructor(\n        private readonly vcr: ViewContainerRef,\n        private readonly i: Injector,\n        private readonly t: TemplateRef<PolymorpheusContext<PolymorpheusPrimitive>>,\n    ) {}\n\n    private get template(): TemplateRef<unknown> {\n        if (isDirective(this.content)) {\n            return this.content.template;\n        }\n\n        return this.content instanceof TemplateRef ? this.content : this.t;\n    }\n\n    ngOnChanges({content}: SimpleChanges): void {\n        const context = this.getContext();\n\n        this.c?.injector.get(ChangeDetectorRef).markForCheck();\n\n        if (!content) {\n            return;\n        }\n\n        this.vcr.clear();\n\n        const proxy =\n            context &&\n            (new Proxy(context as object, {\n                get: (_, key) =>\n                    this.getContext()?.[key as keyof (C | PolymorpheusContext<any>)],\n            }) as unknown as C);\n\n        if (isComponent(this.content)) {\n            this.process(this.content, proxy);\n        } else if (\n            // tslint:disable-next-line:triple-equals\n            (context instanceof PolymorpheusContext && context.$implicit) != null\n        ) {\n            this.vcr.createEmbeddedView(this.template, proxy);\n        }\n    }\n\n    ngDoCheck() {\n        if (isDirective(this.content)) {\n            this.content.check();\n        }\n    }\n\n    static ngTemplateContextGuard<T>(\n        _dir: PolymorpheusOutletDirective<T>,\n        _ctx: any,\n    ): _ctx is PolymorpheusContext<T extends PolymorpheusPrimitive ? T : never> {\n        return true;\n    }\n\n    private getContext(): C | undefined | PolymorpheusContext<any> {\n        if (isTemplate(this.content) || isComponent(this.content)) {\n            return this.context;\n        }\n\n        return new PolymorpheusContext(\n            typeof this.content === 'function'\n                ? this.content(this.context!)\n                : this.content,\n        );\n    }\n\n    private process(content: PolymorpheusComponent<unknown>, proxy?: C): void {\n        const injector = content.createInjector(this.i, proxy);\n\n        this.c = this.vcr.createComponent(\n            injector\n                .get(ComponentFactoryResolver)\n                .resolveComponentFactory(content.component),\n            0,\n            injector,\n        );\n    }\n}\n\nfunction isDirective<C>(\n    content: PolymorpheusContent<C>,\n): content is PolymorpheusTemplate<C> {\n    return content instanceof PolymorpheusTemplate;\n}\n\nfunction isComponent<C>(\n    content: PolymorpheusContent<C>,\n): content is PolymorpheusComponent<any, C> {\n    return content instanceof PolymorpheusComponent;\n}\n\nfunction isTemplate<C>(\n    content: PolymorpheusContent<C>,\n): content is PolymorpheusTemplate<C> | TemplateRef<C> {\n    return isDirective(content) || content instanceof TemplateRef;\n}\n","import {NgModule} from '@angular/core';\nimport {PolymorpheusOutletDirective} from './directives/outlet';\nimport {PolymorpheusTemplate} from './directives/template';\n\n@NgModule({\n    declarations: [PolymorpheusOutletDirective, PolymorpheusTemplate],\n    exports: [PolymorpheusOutletDirective, PolymorpheusTemplate],\n})\nexport class PolymorpheusModule {}\n","/**\n * Public API Surface of ng-polymorpheus\n */\nexport * from './classes/component';\nexport * from './directives/template';\nexport * from './directives/outlet';\nexport * from './tokens/context';\nexport * from './types/content';\nexport * from './types/handler';\nexport * from './types/primitive';\nexport * from './polymorpheus.module';\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './public-api';\n"],"names":[],"mappings":"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"}