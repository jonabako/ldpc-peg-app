import { ChangeDetectorRef, ComponentFactoryResolver, Directive, TemplateRef, } from '@angular/core';
import { PolymorpheusComponent } from '../classes/component';
import { PolymorpheusContext } from '../classes/context';
import { PolymorpheusTemplate } from './template';
import * as i0 from "@angular/core";
export class PolymorpheusOutletDirective {
    constructor(vcr, i, t) {
        this.vcr = vcr;
        this.i = i;
        this.t = t;
        this.content = '';
    }
    get template() {
        if (isDirective(this.content)) {
            return this.content.template;
        }
        return this.content instanceof TemplateRef ? this.content : this.t;
    }
    ngOnChanges({ content }) {
        var _a;
        const context = this.getContext();
        (_a = this.c) === null || _a === void 0 ? void 0 : _a.injector.get(ChangeDetectorRef).markForCheck();
        if (!content) {
            return;
        }
        this.vcr.clear();
        const proxy = context &&
            new Proxy(context, {
                get: (_, key) => { var _a; return (_a = this.getContext()) === null || _a === void 0 ? void 0 : _a[key]; },
            });
        if (isComponent(this.content)) {
            this.process(this.content, proxy);
        }
        else if (
        // tslint:disable-next-line:triple-equals
        (context instanceof PolymorpheusContext && context.$implicit) != null) {
            this.vcr.createEmbeddedView(this.template, proxy);
        }
    }
    ngDoCheck() {
        if (isDirective(this.content)) {
            this.content.check();
        }
    }
    static ngTemplateContextGuard(_dir, _ctx) {
        return true;
    }
    getContext() {
        if (isTemplate(this.content) || isComponent(this.content)) {
            return this.context;
        }
        return new PolymorpheusContext(typeof this.content === 'function'
            ? this.content(this.context)
            : this.content);
    }
    process(content, proxy) {
        const injector = content.createInjector(this.i, proxy);
        this.c = this.vcr.createComponent(injector
            .get(ComponentFactoryResolver)
            .resolveComponentFactory(content.component), 0, injector);
    }
}
/** @nocollapse */ PolymorpheusOutletDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.17", ngImport: i0, type: PolymorpheusOutletDirective, deps: [{ token: i0.ViewContainerRef }, { token: i0.Injector }, { token: i0.TemplateRef }], target: i0.ɵɵFactoryTarget.Directive });
/** @nocollapse */ PolymorpheusOutletDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "12.2.17", type: PolymorpheusOutletDirective, selector: "[polymorpheusOutlet]", inputs: { content: ["polymorpheusOutlet", "content"], context: ["polymorpheusOutletContext", "context"] }, usesOnChanges: true, ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.17", ngImport: i0, type: PolymorpheusOutletDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: '[polymorpheusOutlet]',
                    inputs: ['content: polymorpheusOutlet', 'context: polymorpheusOutletContext'],
                }]
        }], ctorParameters: function () { return [{ type: i0.ViewContainerRef }, { type: i0.Injector }, { type: i0.TemplateRef }]; } });
function isDirective(content) {
    return content instanceof PolymorpheusTemplate;
}
function isComponent(content) {
    return content instanceof PolymorpheusComponent;
}
function isTemplate(content) {
    return isDirective(content) || content instanceof TemplateRef;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3V0bGV0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvbmctcG9seW1vcnBoZXVzL3NyYy9kaXJlY3RpdmVzL291dGxldC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0gsaUJBQWlCLEVBQ2pCLHdCQUF3QixFQUV4QixTQUFTLEVBS1QsV0FBVyxHQUVkLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBQyxxQkFBcUIsRUFBQyxNQUFNLHNCQUFzQixDQUFDO0FBQzNELE9BQU8sRUFBQyxtQkFBbUIsRUFBQyxNQUFNLG9CQUFvQixDQUFDO0FBR3ZELE9BQU8sRUFBQyxvQkFBb0IsRUFBQyxNQUFNLFlBQVksQ0FBQzs7QUFNaEQsTUFBTSxPQUFPLDJCQUEyQjtJQU1wQyxZQUNxQixHQUFxQixFQUNyQixDQUFXLEVBQ1gsQ0FBMEQ7UUFGMUQsUUFBRyxHQUFILEdBQUcsQ0FBa0I7UUFDckIsTUFBQyxHQUFELENBQUMsQ0FBVTtRQUNYLE1BQUMsR0FBRCxDQUFDLENBQXlEO1FBTi9FLFlBQU8sR0FBMkIsRUFBRSxDQUFDO0lBT2xDLENBQUM7SUFFSixJQUFZLFFBQVE7UUFDaEIsSUFBSSxXQUFXLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQzNCLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUM7U0FDaEM7UUFFRCxPQUFPLElBQUksQ0FBQyxPQUFPLFlBQVksV0FBVyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQ3ZFLENBQUM7SUFFRCxXQUFXLENBQUMsRUFBQyxPQUFPLEVBQWdCOztRQUNoQyxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7UUFFbEMsTUFBQSxJQUFJLENBQUMsQ0FBQywwQ0FBRSxRQUFRLENBQUMsR0FBRyxDQUFDLGlCQUFpQixFQUFFLFlBQVksRUFBRSxDQUFDO1FBRXZELElBQUksQ0FBQyxPQUFPLEVBQUU7WUFDVixPQUFPO1NBQ1Y7UUFFRCxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBRWpCLE1BQU0sS0FBSyxHQUNQLE9BQU87WUFDTixJQUFJLEtBQUssQ0FBQyxPQUFpQixFQUFFO2dCQUMxQixHQUFHLEVBQUUsQ0FBQyxDQUFDLEVBQUUsR0FBRyxFQUFFLEVBQUUsV0FDWixPQUFBLE1BQUEsSUFBSSxDQUFDLFVBQVUsRUFBRSwwQ0FBRyxHQUEyQyxDQUFDLENBQUEsRUFBQTthQUN2RSxDQUFrQixDQUFDO1FBRXhCLElBQUksV0FBVyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRTtZQUMzQixJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsS0FBSyxDQUFDLENBQUM7U0FDckM7YUFBTTtRQUNILHlDQUF5QztRQUN6QyxDQUFDLE9BQU8sWUFBWSxtQkFBbUIsSUFBSSxPQUFPLENBQUMsU0FBUyxDQUFDLElBQUksSUFBSSxFQUN2RTtZQUNFLElBQUksQ0FBQyxHQUFHLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxLQUFLLENBQUMsQ0FBQztTQUNyRDtJQUNMLENBQUM7SUFFRCxTQUFTO1FBQ0wsSUFBSSxXQUFXLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQzNCLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLENBQUM7U0FDeEI7SUFDTCxDQUFDO0lBRUQsTUFBTSxDQUFDLHNCQUFzQixDQUN6QixJQUFvQyxFQUNwQyxJQUFTO1FBRVQsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVPLFVBQVU7UUFDZCxJQUFJLFVBQVUsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksV0FBVyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRTtZQUN2RCxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUM7U0FDdkI7UUFFRCxPQUFPLElBQUksbUJBQW1CLENBQzFCLE9BQU8sSUFBSSxDQUFDLE9BQU8sS0FBSyxVQUFVO1lBQzlCLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFRLENBQUM7WUFDN0IsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQ3JCLENBQUM7SUFDTixDQUFDO0lBRU8sT0FBTyxDQUFDLE9BQXVDLEVBQUUsS0FBUztRQUM5RCxNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFdkQsSUFBSSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLGVBQWUsQ0FDN0IsUUFBUTthQUNILEdBQUcsQ0FBQyx3QkFBd0IsQ0FBQzthQUM3Qix1QkFBdUIsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLEVBQy9DLENBQUMsRUFDRCxRQUFRLENBQ1gsQ0FBQztJQUNOLENBQUM7OzRJQW5GUSwyQkFBMkI7Z0lBQTNCLDJCQUEyQjs0RkFBM0IsMkJBQTJCO2tCQUp2QyxTQUFTO21CQUFDO29CQUNQLFFBQVEsRUFBRSxzQkFBc0I7b0JBQ2hDLE1BQU0sRUFBRSxDQUFDLDZCQUE2QixFQUFFLG9DQUFvQyxDQUFDO2lCQUNoRjs7QUF1RkQsU0FBUyxXQUFXLENBQ2hCLE9BQStCO0lBRS9CLE9BQU8sT0FBTyxZQUFZLG9CQUFvQixDQUFDO0FBQ25ELENBQUM7QUFFRCxTQUFTLFdBQVcsQ0FDaEIsT0FBK0I7SUFFL0IsT0FBTyxPQUFPLFlBQVkscUJBQXFCLENBQUM7QUFDcEQsQ0FBQztBQUVELFNBQVMsVUFBVSxDQUNmLE9BQStCO0lBRS9CLE9BQU8sV0FBVyxDQUFDLE9BQU8sQ0FBQyxJQUFJLE9BQU8sWUFBWSxXQUFXLENBQUM7QUFDbEUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gICAgQ2hhbmdlRGV0ZWN0b3JSZWYsXG4gICAgQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxuICAgIENvbXBvbmVudFJlZixcbiAgICBEaXJlY3RpdmUsXG4gICAgRG9DaGVjayxcbiAgICBJbmplY3RvcixcbiAgICBPbkNoYW5nZXMsXG4gICAgU2ltcGxlQ2hhbmdlcyxcbiAgICBUZW1wbGF0ZVJlZixcbiAgICBWaWV3Q29udGFpbmVyUmVmLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7UG9seW1vcnBoZXVzQ29tcG9uZW50fSBmcm9tICcuLi9jbGFzc2VzL2NvbXBvbmVudCc7XG5pbXBvcnQge1BvbHltb3JwaGV1c0NvbnRleHR9IGZyb20gJy4uL2NsYXNzZXMvY29udGV4dCc7XG5pbXBvcnQge1BvbHltb3JwaGV1c0NvbnRlbnR9IGZyb20gJy4uL3R5cGVzL2NvbnRlbnQnO1xuaW1wb3J0IHtQb2x5bW9ycGhldXNQcmltaXRpdmV9IGZyb20gJy4uL3R5cGVzL3ByaW1pdGl2ZSc7XG5pbXBvcnQge1BvbHltb3JwaGV1c1RlbXBsYXRlfSBmcm9tICcuL3RlbXBsYXRlJztcblxuQERpcmVjdGl2ZSh7XG4gICAgc2VsZWN0b3I6ICdbcG9seW1vcnBoZXVzT3V0bGV0XScsXG4gICAgaW5wdXRzOiBbJ2NvbnRlbnQ6IHBvbHltb3JwaGV1c091dGxldCcsICdjb250ZXh0OiBwb2x5bW9ycGhldXNPdXRsZXRDb250ZXh0J10sXG59KVxuZXhwb3J0IGNsYXNzIFBvbHltb3JwaGV1c091dGxldERpcmVjdGl2ZTxDPiBpbXBsZW1lbnRzIE9uQ2hhbmdlcywgRG9DaGVjayB7XG4gICAgcHJpdmF0ZSBjPzogQ29tcG9uZW50UmVmPHVua25vd24+O1xuXG4gICAgY29udGVudDogUG9seW1vcnBoZXVzQ29udGVudDxDPiA9ICcnO1xuICAgIGNvbnRleHQ/OiBDO1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIHByaXZhdGUgcmVhZG9ubHkgdmNyOiBWaWV3Q29udGFpbmVyUmVmLFxuICAgICAgICBwcml2YXRlIHJlYWRvbmx5IGk6IEluamVjdG9yLFxuICAgICAgICBwcml2YXRlIHJlYWRvbmx5IHQ6IFRlbXBsYXRlUmVmPFBvbHltb3JwaGV1c0NvbnRleHQ8UG9seW1vcnBoZXVzUHJpbWl0aXZlPj4sXG4gICAgKSB7fVxuXG4gICAgcHJpdmF0ZSBnZXQgdGVtcGxhdGUoKTogVGVtcGxhdGVSZWY8dW5rbm93bj4ge1xuICAgICAgICBpZiAoaXNEaXJlY3RpdmUodGhpcy5jb250ZW50KSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuY29udGVudC50ZW1wbGF0ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLmNvbnRlbnQgaW5zdGFuY2VvZiBUZW1wbGF0ZVJlZiA/IHRoaXMuY29udGVudCA6IHRoaXMudDtcbiAgICB9XG5cbiAgICBuZ09uQ2hhbmdlcyh7Y29udGVudH06IFNpbXBsZUNoYW5nZXMpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgY29udGV4dCA9IHRoaXMuZ2V0Q29udGV4dCgpO1xuXG4gICAgICAgIHRoaXMuYz8uaW5qZWN0b3IuZ2V0KENoYW5nZURldGVjdG9yUmVmKS5tYXJrRm9yQ2hlY2soKTtcblxuICAgICAgICBpZiAoIWNvbnRlbnQpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMudmNyLmNsZWFyKCk7XG5cbiAgICAgICAgY29uc3QgcHJveHkgPVxuICAgICAgICAgICAgY29udGV4dCAmJlxuICAgICAgICAgICAgKG5ldyBQcm94eShjb250ZXh0IGFzIG9iamVjdCwge1xuICAgICAgICAgICAgICAgIGdldDogKF8sIGtleSkgPT5cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXRDb250ZXh0KCk/LltrZXkgYXMga2V5b2YgKEMgfCBQb2x5bW9ycGhldXNDb250ZXh0PGFueT4pXSxcbiAgICAgICAgICAgIH0pIGFzIHVua25vd24gYXMgQyk7XG5cbiAgICAgICAgaWYgKGlzQ29tcG9uZW50KHRoaXMuY29udGVudCkpIHtcbiAgICAgICAgICAgIHRoaXMucHJvY2Vzcyh0aGlzLmNvbnRlbnQsIHByb3h5KTtcbiAgICAgICAgfSBlbHNlIGlmIChcbiAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTp0cmlwbGUtZXF1YWxzXG4gICAgICAgICAgICAoY29udGV4dCBpbnN0YW5jZW9mIFBvbHltb3JwaGV1c0NvbnRleHQgJiYgY29udGV4dC4kaW1wbGljaXQpICE9IG51bGxcbiAgICAgICAgKSB7XG4gICAgICAgICAgICB0aGlzLnZjci5jcmVhdGVFbWJlZGRlZFZpZXcodGhpcy50ZW1wbGF0ZSwgcHJveHkpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgbmdEb0NoZWNrKCkge1xuICAgICAgICBpZiAoaXNEaXJlY3RpdmUodGhpcy5jb250ZW50KSkge1xuICAgICAgICAgICAgdGhpcy5jb250ZW50LmNoZWNrKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBzdGF0aWMgbmdUZW1wbGF0ZUNvbnRleHRHdWFyZDxUPihcbiAgICAgICAgX2RpcjogUG9seW1vcnBoZXVzT3V0bGV0RGlyZWN0aXZlPFQ+LFxuICAgICAgICBfY3R4OiBhbnksXG4gICAgKTogX2N0eCBpcyBQb2x5bW9ycGhldXNDb250ZXh0PFQgZXh0ZW5kcyBQb2x5bW9ycGhldXNQcmltaXRpdmUgPyBUIDogbmV2ZXI+IHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRDb250ZXh0KCk6IEMgfCB1bmRlZmluZWQgfCBQb2x5bW9ycGhldXNDb250ZXh0PGFueT4ge1xuICAgICAgICBpZiAoaXNUZW1wbGF0ZSh0aGlzLmNvbnRlbnQpIHx8IGlzQ29tcG9uZW50KHRoaXMuY29udGVudCkpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbnRleHQ7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbmV3IFBvbHltb3JwaGV1c0NvbnRleHQoXG4gICAgICAgICAgICB0eXBlb2YgdGhpcy5jb250ZW50ID09PSAnZnVuY3Rpb24nXG4gICAgICAgICAgICAgICAgPyB0aGlzLmNvbnRlbnQodGhpcy5jb250ZXh0ISlcbiAgICAgICAgICAgICAgICA6IHRoaXMuY29udGVudCxcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHByb2Nlc3MoY29udGVudDogUG9seW1vcnBoZXVzQ29tcG9uZW50PHVua25vd24+LCBwcm94eT86IEMpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgaW5qZWN0b3IgPSBjb250ZW50LmNyZWF0ZUluamVjdG9yKHRoaXMuaSwgcHJveHkpO1xuXG4gICAgICAgIHRoaXMuYyA9IHRoaXMudmNyLmNyZWF0ZUNvbXBvbmVudChcbiAgICAgICAgICAgIGluamVjdG9yXG4gICAgICAgICAgICAgICAgLmdldChDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIpXG4gICAgICAgICAgICAgICAgLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KGNvbnRlbnQuY29tcG9uZW50KSxcbiAgICAgICAgICAgIDAsXG4gICAgICAgICAgICBpbmplY3RvcixcbiAgICAgICAgKTtcbiAgICB9XG59XG5cbmZ1bmN0aW9uIGlzRGlyZWN0aXZlPEM+KFxuICAgIGNvbnRlbnQ6IFBvbHltb3JwaGV1c0NvbnRlbnQ8Qz4sXG4pOiBjb250ZW50IGlzIFBvbHltb3JwaGV1c1RlbXBsYXRlPEM+IHtcbiAgICByZXR1cm4gY29udGVudCBpbnN0YW5jZW9mIFBvbHltb3JwaGV1c1RlbXBsYXRlO1xufVxuXG5mdW5jdGlvbiBpc0NvbXBvbmVudDxDPihcbiAgICBjb250ZW50OiBQb2x5bW9ycGhldXNDb250ZW50PEM+LFxuKTogY29udGVudCBpcyBQb2x5bW9ycGhldXNDb21wb25lbnQ8YW55LCBDPiB7XG4gICAgcmV0dXJuIGNvbnRlbnQgaW5zdGFuY2VvZiBQb2x5bW9ycGhldXNDb21wb25lbnQ7XG59XG5cbmZ1bmN0aW9uIGlzVGVtcGxhdGU8Qz4oXG4gICAgY29udGVudDogUG9seW1vcnBoZXVzQ29udGVudDxDPixcbik6IGNvbnRlbnQgaXMgUG9seW1vcnBoZXVzVGVtcGxhdGU8Qz4gfCBUZW1wbGF0ZVJlZjxDPiB7XG4gICAgcmV0dXJuIGlzRGlyZWN0aXZlKGNvbnRlbnQpIHx8IGNvbnRlbnQgaW5zdGFuY2VvZiBUZW1wbGF0ZVJlZjtcbn1cbiJdfQ==