import { __decorate } from "tslib";
import { ChangeDetectionStrategy, Component, ElementRef, HostListener, Inject, Input, NgZone, Self, ViewChild, ViewChildren, } from '@angular/core';
import { EMPTY_QUERY, TUI_IS_IOS, TuiDestroyService, tuiPure, tuiZonefull, } from '@taiga-ui/cdk';
import { tuiSlideInTop } from '@taiga-ui/core';
import { TUI_MORE_WORD } from '@taiga-ui/kit';
import { timer } from 'rxjs';
import { map, takeUntil } from 'rxjs/operators';
import { TUI_SHEET_SCROLL } from '../../sheet-tokens';
import { TUI_SHEET_ID } from '../sheet-heading/sheet-heading.component';
import { TUI_SHEET_PROVIDERS } from './sheet.providers';
import * as i0 from "@angular/core";
import * as i1 from "../sheet-bar/sheet-bar.component";
import * as i2 from "../sheet-heading/sheet-heading.component";
import * as i3 from "@angular/common";
import * as i4 from "../../directives/sheet-top/sheet-top.directive";
import * as i5 from "@tinkoff/ng-polymorpheus";
import * as i6 from "../../directives/sheet-stop/sheet-stop.directive";
import * as i7 from "rxjs";
export class TuiSheetComponent {
    constructor(scroll$, el, zone, isIos, moreWord$, destroy$) {
        this.scroll$ = scroll$;
        this.el = el;
        this.zone = zone;
        this.isIos = isIos;
        this.moreWord$ = moreWord$;
        this.destroy$ = destroy$;
        this.stopsRefs = EMPTY_QUERY;
        this.id = '';
        this.stuck$ = this.scroll$.pipe(map(y => Math.floor(y) > this.contentTop));
    }
    get stops() {
        return this.getStops(this.stopsRefs);
    }
    get imageStop() {
        return (this.item.imageSlide && this.stops[this.stops.length - 1]) || 0;
    }
    get imageHeight() {
        return this.contentTop - this.sheetTop;
    }
    get context() {
        return Object.assign(Object.assign({}, this.item), { scroll$: this.scroll$.pipe(tuiZonefull(this.zone)) });
    }
    onId(id) {
        this.id = id;
    }
    ngAfterViewInit() {
        this.el.nativeElement.scrollTop = [...this.stops, this.sheetTop, this.contentTop][this.item.initial];
    }
    scrollTo(top = this.sheetTop) {
        const { nativeElement } = this.el;
        if (this.isIos) {
            const offset = top - nativeElement.scrollTop - 16;
            nativeElement.style.transition = 'none';
            nativeElement.style.transform = `scaleX(-1) translate3d(0, ${offset}px, 0)`;
            timer(0)
                .pipe(takeUntil(this.destroy$))
                .subscribe(() => {
                nativeElement.style.transition = '';
                nativeElement.style.transform = '';
            });
        }
        nativeElement.scrollTo({ top, behavior: 'smooth' });
    }
    close() {
        if (this.context.closeable) {
            this.context.$implicit.complete();
        }
    }
    get contentTop() {
        var _a, _b;
        return (_b = (_a = this.content) === null || _a === void 0 ? void 0 : _a.nativeElement.offsetTop) !== null && _b !== void 0 ? _b : Infinity;
    }
    get sheetTop() {
        var _a, _b;
        return (_b = (_a = this.sheet) === null || _a === void 0 ? void 0 : _a.nativeElement.offsetTop) !== null && _b !== void 0 ? _b : Infinity;
    }
    getStops(stops) {
        return stops.map(({ nativeElement }) => nativeElement.offsetTop + nativeElement.clientHeight);
    }
}
TuiSheetComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.17", ngImport: i0, type: TuiSheetComponent, deps: [{ token: TUI_SHEET_SCROLL }, { token: ElementRef }, { token: NgZone }, { token: TUI_IS_IOS }, { token: TUI_MORE_WORD }, { token: TuiDestroyService, self: true }], target: i0.ɵɵFactoryTarget.Component });
TuiSheetComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "12.2.17", type: TuiSheetComponent, selector: "tui-sheet", inputs: { item: "item" }, host: { attributes: { "role": "dialog" }, listeners: { "$.class._stuck": "stuck$", "tui-sheet-id": "onId($event.detail)" }, properties: { "attr.aria-labelledby": "id", "class._ios": "isIos", "$.class._stuck": "stuck$" } }, providers: TUI_SHEET_PROVIDERS, viewQueries: [{ propertyName: "sheet", first: true, predicate: ["sheet"], descendants: true }, { propertyName: "content", first: true, predicate: ["content"], descendants: true }, { propertyName: "stopsRefs", predicate: ["stops"], descendants: true }], ngImport: i0, template: "<div\n    class=\"t-bumpers\"\n    (click)=\"close()\"\n>\n    <div\n        *ngFor=\"let stop of item.stops\"\n        #stops\n        class=\"t-bumper\"\n        [style.marginTop]=\"stop\"\n    ></div>\n</div>\n<div\n    #sheet\n    class=\"t-wrapper\"\n    [class.t-wrapper_shadow]=\"!item.image\"\n>\n    <header\n        *ngIf=\"item.image\"\n        class=\"t-top\"\n        [tuiSheetTop]=\"imageStop\"\n    >\n        <img\n            *polymorpheusOutlet=\"item.image as src; context: context\"\n            alt=\"\"\n            class=\"t-image\"\n            [src]=\"src\"\n        />\n    </header>\n    <section\n        #content\n        tuiSheetStop\n        class=\"t-sheet\"\n    >\n        <div class=\"t-bar\"></div>\n        <tui-sheet-bar>\n            <button\n                type=\"button\"\n                class=\"t-button\"\n                [title]=\"moreWord$ | async\"\n                (click)=\"scrollTo(stops[1])\"\n            ></button>\n        </tui-sheet-bar>\n        <div class=\"t-content\">\n            <h2\n                *polymorpheusOutlet=\"item.content as text; context: context\"\n                tuiSheetHeading\n                class=\"t-heading\"\n            >\n                {{ text }}\n            </h2>\n        </div>\n    </section>\n</div>\n", styles: [":host{scrollbar-width:none;-ms-overflow-style:none;position:absolute;top:0;left:0;bottom:0;right:0;transition-property:transform;transition-duration:var(--tui-duration, .3s);transition-timing-function:ease-in-out;top:auto;border-radius:.75rem .75rem 0 0;overflow-y:auto;overflow-x:hidden;scroll-snap-type:y mandatory;box-shadow:0 50vh var(--tui-elevation-01);padding-right:1rem;margin-left:-1rem;transform:scaleX(-1);-webkit-clip-path:inset(0 1rem 0 0 round .75rem .75rem 0 0);clip-path:inset(0 1rem 0 0 round .75rem .75rem 0 0)}:host::-webkit-scrollbar,:host::-webkit-scrollbar-thumb{display:none}:host._stuck{scroll-snap-type:none}@supports (-moz-appearance: none){:host{scroll-snap-type:none}}.t-bumpers{display:flex;height:100%}:host-context(.t-wrapper_closeable) .t-bumpers{scroll-snap-stop:always;scroll-snap-align:start;scroll-margin:-1px}.t-bumper{scroll-snap-stop:always;scroll-snap-align:start;height:1rem;width:1rem}.t-wrapper{border-radius:inherit;scroll-snap-stop:always;scroll-snap-align:start}.t-wrapper_shadow{box-shadow:var(--tui-shadow)}.t-top{position:-webkit-sticky;position:sticky;top:0;border-radius:.8rem .8rem 0 0;box-shadow:var(--tui-shadow);transform:scaleX(-1);overflow:hidden}.t-top._clickthrough{pointer-events:none}:host-context(._overlay:not(._visible)) .t-top{transition-property:transform;transition-duration:var(--tui-duration, .3s);transition-timing-function:ease-in-out;transform:scaleX(-1)!important}.t-image{display:block;width:100%}.t-sheet{position:relative;border-radius:inherit;scroll-snap-stop:always;scroll-snap-align:start;transform:scaleX(-1)}.t-top:not(._rounded)~.t-sheet .t-bar{border-radius:0}.t-bar{transition-property:border-radius;transition-duration:var(--tui-duration, .3s);transition-timing-function:ease-in-out;position:-webkit-sticky;position:sticky;top:0;z-index:1;height:1.5rem;margin-bottom:-1.5rem;border-radius:inherit;background:var(--tui-elevation-01);box-shadow:inset 0 1px #ffffff40}.t-button{position:absolute;top:0;height:1.5rem;width:3rem;padding:0;border:0;opacity:0}.t-content{padding:1rem;margin-top:-1rem;border-radius:inherit;background:var(--tui-elevation-01)}.t-heading{padding-bottom:.5rem;background:var(--tui-elevation-01)}\n"], components: [{ type: i1.TuiSheetBarComponent, selector: "tui-sheet-bar" }, { type: i2.TuiSheetHeadingComponent, selector: "[tuiSheetHeading]" }], directives: [{ type: i3.NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }, { type: i3.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { type: i4.TuiSheetTopDirective, selector: "[tuiSheetTop]", inputs: ["tuiSheetTop"] }, { type: i5.PolymorpheusOutletDirective, selector: "[polymorpheusOutlet]", inputs: ["polymorpheusOutlet", "polymorpheusOutletContext"] }, { type: i6.TuiSheetStopDirective, selector: "[tuiSheetStop]" }], pipes: { "async": i3.AsyncPipe }, animations: [tuiSlideInTop], changeDetection: i0.ChangeDetectionStrategy.OnPush });
__decorate([
    tuiPure
], TuiSheetComponent.prototype, "context", null);
__decorate([
    tuiPure
], TuiSheetComponent.prototype, "getStops", null);
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.17", ngImport: i0, type: TuiSheetComponent, decorators: [{
            type: Component,
            args: [{
                    selector: 'tui-sheet',
                    templateUrl: './sheet.template.html',
                    styleUrls: ['./sheet.style.less'],
                    changeDetection: ChangeDetectionStrategy.OnPush,
                    providers: TUI_SHEET_PROVIDERS,
                    host: {
                        role: 'dialog',
                        '[attr.aria-labelledby]': 'id',
                        '[class._ios]': 'isIos',
                        // '[class._stuck]': 'true', // Initially disable snapping for Firefox
                        '[$.class._stuck]': 'stuck$',
                        '($.class._stuck)': 'stuck$',
                    },
                    animations: [tuiSlideInTop],
                }]
        }], ctorParameters: function () { return [{ type: i7.Observable, decorators: [{
                    type: Inject,
                    args: [TUI_SHEET_SCROLL]
                }] }, { type: i0.ElementRef, decorators: [{
                    type: Inject,
                    args: [ElementRef]
                }] }, { type: i0.NgZone, decorators: [{
                    type: Inject,
                    args: [NgZone]
                }] }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [TUI_IS_IOS]
                }] }, { type: i7.Observable, decorators: [{
                    type: Inject,
                    args: [TUI_MORE_WORD]
                }] }, { type: i7.Observable, decorators: [{
                    type: Self
                }, {
                    type: Inject,
                    args: [TuiDestroyService]
                }] }]; }, propDecorators: { sheet: [{
                type: ViewChild,
                args: ['sheet']
            }], content: [{
                type: ViewChild,
                args: ['content']
            }], stopsRefs: [{
                type: ViewChildren,
                args: ['stops']
            }], item: [{
                type: Input
            }], context: [], onId: [{
                type: HostListener,
                args: [TUI_SHEET_ID, ['$event.detail']]
            }], getStops: [] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2hlZXQuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvYWRkb24tbW9iaWxlL2NvbXBvbmVudHMvc2hlZXQvY29tcG9uZW50cy9zaGVldC9zaGVldC5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9hZGRvbi1tb2JpbGUvY29tcG9uZW50cy9zaGVldC9jb21wb25lbnRzL3NoZWV0L3NoZWV0LnRlbXBsYXRlLmh0bWwiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFFSCx1QkFBdUIsRUFDdkIsU0FBUyxFQUNULFVBQVUsRUFDVixZQUFZLEVBQ1osTUFBTSxFQUNOLEtBQUssRUFDTCxNQUFNLEVBRU4sSUFBSSxFQUNKLFNBQVMsRUFDVCxZQUFZLEdBQ2YsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUNILFdBQVcsRUFDWCxVQUFVLEVBQ1YsaUJBQWlCLEVBQ2pCLE9BQU8sRUFDUCxXQUFXLEdBQ2QsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFDLGFBQWEsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQzdDLE9BQU8sRUFBQyxhQUFhLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFDNUMsT0FBTyxFQUFhLEtBQUssRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUN2QyxPQUFPLEVBQUMsR0FBRyxFQUFFLFNBQVMsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBRzlDLE9BQU8sRUFBQyxnQkFBZ0IsRUFBQyxNQUFNLG9CQUFvQixDQUFDO0FBQ3BELE9BQU8sRUFBQyxZQUFZLEVBQUMsTUFBTSwwQ0FBMEMsQ0FBQztBQUN0RSxPQUFPLEVBQUMsbUJBQW1CLEVBQUMsTUFBTSxtQkFBbUIsQ0FBQzs7Ozs7Ozs7O0FBa0J0RCxNQUFNLE9BQU8saUJBQWlCO0lBaUIxQixZQUMrQyxPQUEyQixFQUNqQyxFQUEyQixFQUMvQixJQUFZLEVBQ2hCLEtBQWMsRUFDWCxTQUE2QixFQUNULFFBQTBCO1FBTG5DLFlBQU8sR0FBUCxPQUFPLENBQW9CO1FBQ2pDLE9BQUUsR0FBRixFQUFFLENBQXlCO1FBQy9CLFNBQUksR0FBSixJQUFJLENBQVE7UUFDaEIsVUFBSyxHQUFMLEtBQUssQ0FBUztRQUNYLGNBQVMsR0FBVCxTQUFTLENBQW9CO1FBQ1QsYUFBUSxHQUFSLFFBQVEsQ0FBa0I7UUFmakUsY0FBUyxHQUF1QyxXQUFXLENBQUM7UUFLN0UsT0FBRSxHQUFHLEVBQUUsQ0FBQztRQUVDLFdBQU0sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO0lBUzVFLENBQUM7SUFFSixJQUFJLEtBQUs7UUFDTCxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ3pDLENBQUM7SUFFRCxJQUFJLFNBQVM7UUFDVCxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM1RSxDQUFDO0lBRUQsSUFBSSxXQUFXO1FBQ1gsT0FBTyxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUM7SUFDM0MsQ0FBQztJQUdELElBQUksT0FBTztRQUNQLHVDQUNPLElBQUksQ0FBQyxJQUFJLEtBQ1osT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsSUFDcEQ7SUFDTixDQUFDO0lBR0QsSUFBSSxDQUFDLEVBQVU7UUFDWCxJQUFJLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQztJQUNqQixDQUFDO0lBRUQsZUFBZTtRQUNYLElBQUksQ0FBQyxFQUFFLENBQUMsYUFBYSxDQUFDLFNBQVMsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FDN0UsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQ3BCLENBQUM7SUFDTixDQUFDO0lBRUQsUUFBUSxDQUFDLE1BQWMsSUFBSSxDQUFDLFFBQVE7UUFDaEMsTUFBTSxFQUFDLGFBQWEsRUFBQyxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUM7UUFFaEMsSUFBSSxJQUFJLENBQUMsS0FBSyxFQUFFO1lBQ1osTUFBTSxNQUFNLEdBQUcsR0FBRyxHQUFHLGFBQWEsQ0FBQyxTQUFTLEdBQUcsRUFBRSxDQUFDO1lBRWxELGFBQWEsQ0FBQyxLQUFLLENBQUMsVUFBVSxHQUFHLE1BQU0sQ0FBQztZQUN4QyxhQUFhLENBQUMsS0FBSyxDQUFDLFNBQVMsR0FBRyw2QkFBNkIsTUFBTSxRQUFRLENBQUM7WUFFNUUsS0FBSyxDQUFDLENBQUMsQ0FBQztpQkFDSCxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztpQkFDOUIsU0FBUyxDQUFDLEdBQUcsRUFBRTtnQkFDWixhQUFhLENBQUMsS0FBSyxDQUFDLFVBQVUsR0FBRyxFQUFFLENBQUM7Z0JBQ3BDLGFBQWEsQ0FBQyxLQUFLLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQztZQUN2QyxDQUFDLENBQUMsQ0FBQztTQUNWO1FBRUQsYUFBYSxDQUFDLFFBQVEsQ0FBQyxFQUFDLEdBQUcsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFDLENBQUMsQ0FBQztJQUN0RCxDQUFDO0lBRUQsS0FBSztRQUNELElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUU7WUFDeEIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFLENBQUM7U0FDckM7SUFDTCxDQUFDO0lBRUQsSUFBWSxVQUFVOztRQUNsQixPQUFPLE1BQUEsTUFBQSxJQUFJLENBQUMsT0FBTywwQ0FBRSxhQUFhLENBQUMsU0FBUyxtQ0FBSSxRQUFRLENBQUM7SUFDN0QsQ0FBQztJQUVELElBQVksUUFBUTs7UUFDaEIsT0FBTyxNQUFBLE1BQUEsSUFBSSxDQUFDLEtBQUssMENBQUUsYUFBYSxDQUFDLFNBQVMsbUNBQUksUUFBUSxDQUFDO0lBQzNELENBQUM7SUFHTyxRQUFRLENBQUMsS0FBeUM7UUFDdEQsT0FBTyxLQUFLLENBQUMsR0FBRyxDQUNaLENBQUMsRUFBQyxhQUFhLEVBQUMsRUFBRSxFQUFFLENBQUMsYUFBYSxDQUFDLFNBQVMsR0FBRyxhQUFhLENBQUMsWUFBWSxDQUM1RSxDQUFDO0lBQ04sQ0FBQzs7K0dBaEdRLGlCQUFpQixrQkFrQmQsZ0JBQWdCLGFBQ2hCLFVBQVUsYUFDVixNQUFNLGFBQ04sVUFBVSxhQUNWLGFBQWEsYUFDTCxpQkFBaUI7bUdBdkI1QixpQkFBaUIsNlJBWGYsbUJBQW1CLHVSQ3BDbEMsc3hDQXFEQSxzMUZEUmdCLENBQUMsYUFBYSxDQUFDO0FBeUMzQjtJQURDLE9BQU87Z0RBTVA7QUFnREQ7SUFEQyxPQUFPO2lEQUtQOzRGQWhHUSxpQkFBaUI7a0JBaEI3QixTQUFTO21CQUFDO29CQUNQLFFBQVEsRUFBRSxXQUFXO29CQUNyQixXQUFXLEVBQUUsdUJBQXVCO29CQUNwQyxTQUFTLEVBQUUsQ0FBQyxvQkFBb0IsQ0FBQztvQkFDakMsZUFBZSxFQUFFLHVCQUF1QixDQUFDLE1BQU07b0JBQy9DLFNBQVMsRUFBRSxtQkFBbUI7b0JBQzlCLElBQUksRUFBRTt3QkFDRixJQUFJLEVBQUUsUUFBUTt3QkFDZCx3QkFBd0IsRUFBRSxJQUFJO3dCQUM5QixjQUFjLEVBQUUsT0FBTzt3QkFDdkIsc0VBQXNFO3dCQUN0RSxrQkFBa0IsRUFBRSxRQUFRO3dCQUM1QixrQkFBa0IsRUFBRSxRQUFRO3FCQUMvQjtvQkFDRCxVQUFVLEVBQUUsQ0FBQyxhQUFhLENBQUM7aUJBQzlCOzswQkFtQlEsTUFBTTsyQkFBQyxnQkFBZ0I7OzBCQUN2QixNQUFNOzJCQUFDLFVBQVU7OzBCQUNqQixNQUFNOzJCQUFDLE1BQU07OzBCQUNiLE1BQU07MkJBQUMsVUFBVTs7MEJBQ2pCLE1BQU07MkJBQUMsYUFBYTs7MEJBQ3BCLElBQUk7OzBCQUFJLE1BQU07MkJBQUMsaUJBQWlCOzRDQXJCcEIsS0FBSztzQkFEckIsU0FBUzt1QkFBQyxPQUFPO2dCQUlELE9BQU87c0JBRHZCLFNBQVM7dUJBQUMsU0FBUztnQkFJSCxTQUFTO3NCQUR6QixZQUFZO3VCQUFDLE9BQU87Z0JBSXJCLElBQUk7c0JBREgsS0FBSztnQkE2QkYsT0FBTyxNQVFYLElBQUk7c0JBREgsWUFBWTt1QkFBQyxZQUFZLEVBQUUsQ0FBQyxlQUFlLENBQUM7Z0JBOENyQyxRQUFRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgICBBZnRlclZpZXdJbml0LFxuICAgIENoYW5nZURldGVjdGlvblN0cmF0ZWd5LFxuICAgIENvbXBvbmVudCxcbiAgICBFbGVtZW50UmVmLFxuICAgIEhvc3RMaXN0ZW5lcixcbiAgICBJbmplY3QsXG4gICAgSW5wdXQsXG4gICAgTmdab25lLFxuICAgIFF1ZXJ5TGlzdCxcbiAgICBTZWxmLFxuICAgIFZpZXdDaGlsZCxcbiAgICBWaWV3Q2hpbGRyZW4sXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtcbiAgICBFTVBUWV9RVUVSWSxcbiAgICBUVUlfSVNfSU9TLFxuICAgIFR1aURlc3Ryb3lTZXJ2aWNlLFxuICAgIHR1aVB1cmUsXG4gICAgdHVpWm9uZWZ1bGwsXG59IGZyb20gJ0B0YWlnYS11aS9jZGsnO1xuaW1wb3J0IHt0dWlTbGlkZUluVG9wfSBmcm9tICdAdGFpZ2EtdWkvY29yZSc7XG5pbXBvcnQge1RVSV9NT1JFX1dPUkR9IGZyb20gJ0B0YWlnYS11aS9raXQnO1xuaW1wb3J0IHtPYnNlcnZhYmxlLCB0aW1lcn0gZnJvbSAncnhqcyc7XG5pbXBvcnQge21hcCwgdGFrZVVudGlsfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7VHVpU2hlZXQsIFR1aVNoZWV0UmVxdWlyZWRQcm9wc30gZnJvbSAnLi4vLi4vc2hlZXQnO1xuaW1wb3J0IHtUVUlfU0hFRVRfU0NST0xMfSBmcm9tICcuLi8uLi9zaGVldC10b2tlbnMnO1xuaW1wb3J0IHtUVUlfU0hFRVRfSUR9IGZyb20gJy4uL3NoZWV0LWhlYWRpbmcvc2hlZXQtaGVhZGluZy5jb21wb25lbnQnO1xuaW1wb3J0IHtUVUlfU0hFRVRfUFJPVklERVJTfSBmcm9tICcuL3NoZWV0LnByb3ZpZGVycyc7XG5cbkBDb21wb25lbnQoe1xuICAgIHNlbGVjdG9yOiAndHVpLXNoZWV0JyxcbiAgICB0ZW1wbGF0ZVVybDogJy4vc2hlZXQudGVtcGxhdGUuaHRtbCcsXG4gICAgc3R5bGVVcmxzOiBbJy4vc2hlZXQuc3R5bGUubGVzcyddLFxuICAgIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoLFxuICAgIHByb3ZpZGVyczogVFVJX1NIRUVUX1BST1ZJREVSUyxcbiAgICBob3N0OiB7XG4gICAgICAgIHJvbGU6ICdkaWFsb2cnLFxuICAgICAgICAnW2F0dHIuYXJpYS1sYWJlbGxlZGJ5XSc6ICdpZCcsXG4gICAgICAgICdbY2xhc3MuX2lvc10nOiAnaXNJb3MnLFxuICAgICAgICAvLyAnW2NsYXNzLl9zdHVja10nOiAndHJ1ZScsIC8vIEluaXRpYWxseSBkaXNhYmxlIHNuYXBwaW5nIGZvciBGaXJlZm94XG4gICAgICAgICdbJC5jbGFzcy5fc3R1Y2tdJzogJ3N0dWNrJCcsXG4gICAgICAgICcoJC5jbGFzcy5fc3R1Y2spJzogJ3N0dWNrJCcsXG4gICAgfSxcbiAgICBhbmltYXRpb25zOiBbdHVpU2xpZGVJblRvcF0sXG59KVxuZXhwb3J0IGNsYXNzIFR1aVNoZWV0Q29tcG9uZW50PFQ+IGltcGxlbWVudHMgVHVpU2hlZXRSZXF1aXJlZFByb3BzPFQ+LCBBZnRlclZpZXdJbml0IHtcbiAgICBAVmlld0NoaWxkKCdzaGVldCcpXG4gICAgcHJpdmF0ZSByZWFkb25seSBzaGVldD86IEVsZW1lbnRSZWY8SFRNTEVsZW1lbnQ+O1xuXG4gICAgQFZpZXdDaGlsZCgnY29udGVudCcpXG4gICAgcHJpdmF0ZSByZWFkb25seSBjb250ZW50PzogRWxlbWVudFJlZjxIVE1MRWxlbWVudD47XG5cbiAgICBAVmlld0NoaWxkcmVuKCdzdG9wcycpXG4gICAgcHJpdmF0ZSByZWFkb25seSBzdG9wc1JlZnM6IFF1ZXJ5TGlzdDxFbGVtZW50UmVmPEhUTUxFbGVtZW50Pj4gPSBFTVBUWV9RVUVSWTtcblxuICAgIEBJbnB1dCgpXG4gICAgaXRlbSE6IFR1aVNoZWV0PFQ+O1xuXG4gICAgaWQgPSAnJztcblxuICAgIHJlYWRvbmx5IHN0dWNrJCA9IHRoaXMuc2Nyb2xsJC5waXBlKG1hcCh5ID0+IE1hdGguZmxvb3IoeSkgPiB0aGlzLmNvbnRlbnRUb3ApKTtcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBASW5qZWN0KFRVSV9TSEVFVF9TQ1JPTEwpIHByaXZhdGUgcmVhZG9ubHkgc2Nyb2xsJDogT2JzZXJ2YWJsZTxudW1iZXI+LFxuICAgICAgICBASW5qZWN0KEVsZW1lbnRSZWYpIHByaXZhdGUgcmVhZG9ubHkgZWw6IEVsZW1lbnRSZWY8SFRNTEVsZW1lbnQ+LFxuICAgICAgICBASW5qZWN0KE5nWm9uZSkgcHJpdmF0ZSByZWFkb25seSB6b25lOiBOZ1pvbmUsXG4gICAgICAgIEBJbmplY3QoVFVJX0lTX0lPUykgcmVhZG9ubHkgaXNJb3M6IGJvb2xlYW4sXG4gICAgICAgIEBJbmplY3QoVFVJX01PUkVfV09SRCkgcmVhZG9ubHkgbW9yZVdvcmQkOiBPYnNlcnZhYmxlPHN0cmluZz4sXG4gICAgICAgIEBTZWxmKCkgQEluamVjdChUdWlEZXN0cm95U2VydmljZSkgcHJpdmF0ZSByZWFkb25seSBkZXN0cm95JDogT2JzZXJ2YWJsZTx2b2lkPixcbiAgICApIHt9XG5cbiAgICBnZXQgc3RvcHMoKTogcmVhZG9ubHkgbnVtYmVyW10ge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRTdG9wcyh0aGlzLnN0b3BzUmVmcyk7XG4gICAgfVxuXG4gICAgZ2V0IGltYWdlU3RvcCgpOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gKHRoaXMuaXRlbS5pbWFnZVNsaWRlICYmIHRoaXMuc3RvcHNbdGhpcy5zdG9wcy5sZW5ndGggLSAxXSkgfHwgMDtcbiAgICB9XG5cbiAgICBnZXQgaW1hZ2VIZWlnaHQoKTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY29udGVudFRvcCAtIHRoaXMuc2hlZXRUb3A7XG4gICAgfVxuXG4gICAgQHR1aVB1cmVcbiAgICBnZXQgY29udGV4dCgpOiBUdWlTaGVldDxUPiB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAuLi50aGlzLml0ZW0sXG4gICAgICAgICAgICBzY3JvbGwkOiB0aGlzLnNjcm9sbCQucGlwZSh0dWlab25lZnVsbCh0aGlzLnpvbmUpKSxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBASG9zdExpc3RlbmVyKFRVSV9TSEVFVF9JRCwgWyckZXZlbnQuZGV0YWlsJ10pXG4gICAgb25JZChpZDogc3RyaW5nKTogdm9pZCB7XG4gICAgICAgIHRoaXMuaWQgPSBpZDtcbiAgICB9XG5cbiAgICBuZ0FmdGVyVmlld0luaXQoKTogdm9pZCB7XG4gICAgICAgIHRoaXMuZWwubmF0aXZlRWxlbWVudC5zY3JvbGxUb3AgPSBbLi4udGhpcy5zdG9wcywgdGhpcy5zaGVldFRvcCwgdGhpcy5jb250ZW50VG9wXVtcbiAgICAgICAgICAgIHRoaXMuaXRlbS5pbml0aWFsXG4gICAgICAgIF07XG4gICAgfVxuXG4gICAgc2Nyb2xsVG8odG9wOiBudW1iZXIgPSB0aGlzLnNoZWV0VG9wKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IHtuYXRpdmVFbGVtZW50fSA9IHRoaXMuZWw7XG5cbiAgICAgICAgaWYgKHRoaXMuaXNJb3MpIHtcbiAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IHRvcCAtIG5hdGl2ZUVsZW1lbnQuc2Nyb2xsVG9wIC0gMTY7XG5cbiAgICAgICAgICAgIG5hdGl2ZUVsZW1lbnQuc3R5bGUudHJhbnNpdGlvbiA9ICdub25lJztcbiAgICAgICAgICAgIG5hdGl2ZUVsZW1lbnQuc3R5bGUudHJhbnNmb3JtID0gYHNjYWxlWCgtMSkgdHJhbnNsYXRlM2QoMCwgJHtvZmZzZXR9cHgsIDApYDtcblxuICAgICAgICAgICAgdGltZXIoMClcbiAgICAgICAgICAgICAgICAucGlwZSh0YWtlVW50aWwodGhpcy5kZXN0cm95JCkpXG4gICAgICAgICAgICAgICAgLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIG5hdGl2ZUVsZW1lbnQuc3R5bGUudHJhbnNpdGlvbiA9ICcnO1xuICAgICAgICAgICAgICAgICAgICBuYXRpdmVFbGVtZW50LnN0eWxlLnRyYW5zZm9ybSA9ICcnO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgbmF0aXZlRWxlbWVudC5zY3JvbGxUbyh7dG9wLCBiZWhhdmlvcjogJ3Ntb290aCd9KTtcbiAgICB9XG5cbiAgICBjbG9zZSgpOiB2b2lkIHtcbiAgICAgICAgaWYgKHRoaXMuY29udGV4dC5jbG9zZWFibGUpIHtcbiAgICAgICAgICAgIHRoaXMuY29udGV4dC4kaW1wbGljaXQuY29tcGxldGUoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0IGNvbnRlbnRUb3AoKTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY29udGVudD8ubmF0aXZlRWxlbWVudC5vZmZzZXRUb3AgPz8gSW5maW5pdHk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXQgc2hlZXRUb3AoKTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2hlZXQ/Lm5hdGl2ZUVsZW1lbnQub2Zmc2V0VG9wID8/IEluZmluaXR5O1xuICAgIH1cblxuICAgIEB0dWlQdXJlXG4gICAgcHJpdmF0ZSBnZXRTdG9wcyhzdG9wczogUXVlcnlMaXN0PEVsZW1lbnRSZWY8SFRNTEVsZW1lbnQ+Pik6IHJlYWRvbmx5IG51bWJlcltdIHtcbiAgICAgICAgcmV0dXJuIHN0b3BzLm1hcChcbiAgICAgICAgICAgICh7bmF0aXZlRWxlbWVudH0pID0+IG5hdGl2ZUVsZW1lbnQub2Zmc2V0VG9wICsgbmF0aXZlRWxlbWVudC5jbGllbnRIZWlnaHQsXG4gICAgICAgICk7XG4gICAgfVxufVxuIiwiPGRpdlxuICAgIGNsYXNzPVwidC1idW1wZXJzXCJcbiAgICAoY2xpY2spPVwiY2xvc2UoKVwiXG4+XG4gICAgPGRpdlxuICAgICAgICAqbmdGb3I9XCJsZXQgc3RvcCBvZiBpdGVtLnN0b3BzXCJcbiAgICAgICAgI3N0b3BzXG4gICAgICAgIGNsYXNzPVwidC1idW1wZXJcIlxuICAgICAgICBbc3R5bGUubWFyZ2luVG9wXT1cInN0b3BcIlxuICAgID48L2Rpdj5cbjwvZGl2PlxuPGRpdlxuICAgICNzaGVldFxuICAgIGNsYXNzPVwidC13cmFwcGVyXCJcbiAgICBbY2xhc3MudC13cmFwcGVyX3NoYWRvd109XCIhaXRlbS5pbWFnZVwiXG4+XG4gICAgPGhlYWRlclxuICAgICAgICAqbmdJZj1cIml0ZW0uaW1hZ2VcIlxuICAgICAgICBjbGFzcz1cInQtdG9wXCJcbiAgICAgICAgW3R1aVNoZWV0VG9wXT1cImltYWdlU3RvcFwiXG4gICAgPlxuICAgICAgICA8aW1nXG4gICAgICAgICAgICAqcG9seW1vcnBoZXVzT3V0bGV0PVwiaXRlbS5pbWFnZSBhcyBzcmM7IGNvbnRleHQ6IGNvbnRleHRcIlxuICAgICAgICAgICAgYWx0PVwiXCJcbiAgICAgICAgICAgIGNsYXNzPVwidC1pbWFnZVwiXG4gICAgICAgICAgICBbc3JjXT1cInNyY1wiXG4gICAgICAgIC8+XG4gICAgPC9oZWFkZXI+XG4gICAgPHNlY3Rpb25cbiAgICAgICAgI2NvbnRlbnRcbiAgICAgICAgdHVpU2hlZXRTdG9wXG4gICAgICAgIGNsYXNzPVwidC1zaGVldFwiXG4gICAgPlxuICAgICAgICA8ZGl2IGNsYXNzPVwidC1iYXJcIj48L2Rpdj5cbiAgICAgICAgPHR1aS1zaGVldC1iYXI+XG4gICAgICAgICAgICA8YnV0dG9uXG4gICAgICAgICAgICAgICAgdHlwZT1cImJ1dHRvblwiXG4gICAgICAgICAgICAgICAgY2xhc3M9XCJ0LWJ1dHRvblwiXG4gICAgICAgICAgICAgICAgW3RpdGxlXT1cIm1vcmVXb3JkJCB8IGFzeW5jXCJcbiAgICAgICAgICAgICAgICAoY2xpY2spPVwic2Nyb2xsVG8oc3RvcHNbMV0pXCJcbiAgICAgICAgICAgID48L2J1dHRvbj5cbiAgICAgICAgPC90dWktc2hlZXQtYmFyPlxuICAgICAgICA8ZGl2IGNsYXNzPVwidC1jb250ZW50XCI+XG4gICAgICAgICAgICA8aDJcbiAgICAgICAgICAgICAgICAqcG9seW1vcnBoZXVzT3V0bGV0PVwiaXRlbS5jb250ZW50IGFzIHRleHQ7IGNvbnRleHQ6IGNvbnRleHRcIlxuICAgICAgICAgICAgICAgIHR1aVNoZWV0SGVhZGluZ1xuICAgICAgICAgICAgICAgIGNsYXNzPVwidC1oZWFkaW5nXCJcbiAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICB7eyB0ZXh0IH19XG4gICAgICAgICAgICA8L2gyPlxuICAgICAgICA8L2Rpdj5cbiAgICA8L3NlY3Rpb24+XG48L2Rpdj5cbiJdfQ==