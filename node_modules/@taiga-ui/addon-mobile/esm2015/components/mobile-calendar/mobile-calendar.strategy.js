import { __decorate } from "tslib";
import { MONTHS_IN_YEAR, tuiPure } from '@taiga-ui/cdk';
import { Subject } from 'rxjs';
import { distinctUntilChanged, takeUntil } from 'rxjs/operators';
import { ANDROID_CYCLE, BUFFER, IOS_CYCLE, RANGE, YEARLY_CYCLE, } from './mobile-calendar.const';
const ANDROID_CYCLE_HEIGHT = reduceCycle(ANDROID_CYCLE);
const IOS_CYCLE_HEIGHT = reduceCycle(IOS_CYCLE);
function reduceCycle(cycle, lastYear = 28, lastMonth = 12) {
    return cycle.reduce((total, year, yearIndex) => yearIndex <= lastYear
        ? total +
            year.reduce((sum, month, monthIndex) => yearIndex < lastYear ||
                (yearIndex === lastYear && monthIndex < lastMonth)
                ? sum + month
                : sum, 0)
        : total, 0);
}
/**
 * This scroll strategy is hard wired with styles for iOS and Android.
 * It is dependent on month height on those platforms and is designed to
 * work for {@link TuiMobileCalendarComponent} with years 1906 to 2102
 */
export class TuiMobileCalendarStrategy {
    constructor(isIos, scrollService) {
        this.isIos = isIos;
        this.scrollService = scrollService;
        this.index$ = new Subject();
        this.viewport = null;
        this.destroy$ = new Subject();
    }
    get scrolledIndexChange() {
        return this.index$.pipe(distinctUntilChanged());
    }
    attach(viewport) {
        const cycle = this.isIos ? IOS_CYCLE_HEIGHT : ANDROID_CYCLE_HEIGHT;
        this.viewport = viewport;
        this.viewport.setTotalContentSize(cycle * 7);
        this.updateRenderedRange(this.viewport);
    }
    detach() {
        this.index$.complete();
        this.viewport = null;
        this.destroy$.next();
        this.destroy$.complete();
    }
    onContentScrolled() {
        if (this.viewport) {
            this.updateRenderedRange(this.viewport);
        }
    }
    /** These do not matter for this case */
    onDataLengthChanged() { }
    onContentRendered() { }
    onRenderedOffsetChanged() { }
    scrollToIndex(index, behavior) {
        if (!this.viewport) {
            return;
        }
        const scrollTop = this.getOffsetForIndex(index);
        if (behavior !== 'smooth') {
            this.viewport.scrollToOffset(scrollTop, behavior);
            return;
        }
        this.scrollService
            .scroll$(this.viewport.elementRef.nativeElement, scrollTop)
            .pipe(takeUntil(this.destroy$))
            .subscribe();
    }
    getOffsetForIndex(index) {
        const month = index % MONTHS_IN_YEAR;
        const year = (index - month) / MONTHS_IN_YEAR;
        return this.computeHeight(year, month);
    }
    getIndexForOffset(offset) {
        const cycle = this.isIos ? IOS_CYCLE : ANDROID_CYCLE;
        const cycleHeight = this.isIos ? IOS_CYCLE_HEIGHT : ANDROID_CYCLE_HEIGHT;
        const remainder = offset % cycleHeight;
        const years = ((offset - remainder) / cycleHeight) * YEARLY_CYCLE;
        let accumulator = 0;
        for (let year = 0; year < cycle.length; year++) {
            for (let month = 0; month < cycle[year].length; month++) {
                accumulator += cycle[year][month];
                if (accumulator - cycle[year][month] / 2 > remainder) {
                    return Math.max((years + year) * MONTHS_IN_YEAR + month, 0);
                }
            }
        }
        return RANGE;
    }
    computeHeight(year, month) {
        const cycle = this.isIos ? IOS_CYCLE : ANDROID_CYCLE;
        const remainder = year % YEARLY_CYCLE;
        const remainderHeight = reduceCycle(cycle, remainder, month);
        const fullCycles = (year - remainder) / YEARLY_CYCLE;
        const fullCyclesHeight = this.isIos
            ? fullCycles * IOS_CYCLE_HEIGHT
            : fullCycles * ANDROID_CYCLE_HEIGHT;
        return fullCyclesHeight + remainderHeight;
    }
    updateRenderedRange(viewport) {
        const offset = viewport.measureScrollOffset();
        const { start, end } = viewport.getRenderedRange();
        const viewportSize = viewport.getViewportSize();
        const dataLength = viewport.getDataLength();
        const newRange = { start, end };
        const firstVisibleIndex = this.getIndexForOffset(offset);
        const startBuffer = offset - this.getOffsetForIndex(start);
        if (startBuffer < BUFFER && start !== 0) {
            newRange.start = Math.max(0, this.getIndexForOffset(offset - BUFFER * 2));
            newRange.end = Math.min(dataLength, this.getIndexForOffset(offset + viewportSize + BUFFER));
        }
        else {
            const endBuffer = this.getOffsetForIndex(end) - offset - viewportSize;
            if (endBuffer < BUFFER && end !== dataLength) {
                newRange.start = Math.max(0, this.getIndexForOffset(offset - BUFFER));
                newRange.end = Math.min(dataLength, this.getIndexForOffset(offset + viewportSize + BUFFER * 2));
            }
        }
        viewport.setRenderedRange(newRange);
        viewport.setRenderedContentOffset(this.getOffsetForIndex(newRange.start));
        this.index$.next(firstVisibleIndex);
    }
}
__decorate([
    tuiPure
], TuiMobileCalendarStrategy.prototype, "scrolledIndexChange", null);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9iaWxlLWNhbGVuZGFyLnN0cmF0ZWd5LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvYWRkb24tbW9iaWxlL2NvbXBvbmVudHMvbW9iaWxlLWNhbGVuZGFyL21vYmlsZS1jYWxlbmRhci5zdHJhdGVneS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQ0EsT0FBTyxFQUFDLGNBQWMsRUFBRSxPQUFPLEVBQW1CLE1BQU0sZUFBZSxDQUFDO0FBQ3hFLE9BQU8sRUFBYSxPQUFPLEVBQUMsTUFBTSxNQUFNLENBQUM7QUFDekMsT0FBTyxFQUFDLG9CQUFvQixFQUFFLFNBQVMsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBRS9ELE9BQU8sRUFDSCxhQUFhLEVBQ2IsTUFBTSxFQUNOLFNBQVMsRUFDVCxLQUFLLEVBQ0wsWUFBWSxHQUNmLE1BQU0seUJBQXlCLENBQUM7QUFFakMsTUFBTSxvQkFBb0IsR0FBRyxXQUFXLENBQUMsYUFBYSxDQUFDLENBQUM7QUFDeEQsTUFBTSxnQkFBZ0IsR0FBRyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUM7QUFFaEQsU0FBUyxXQUFXLENBQ2hCLEtBQXVDLEVBQ3ZDLFdBQW1CLEVBQUUsRUFDckIsWUFBb0IsRUFBRTtJQUV0QixPQUFPLEtBQUssQ0FBQyxNQUFNLENBQ2YsQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxFQUFFLENBQ3ZCLFNBQVMsSUFBSSxRQUFRO1FBQ2pCLENBQUMsQ0FBQyxLQUFLO1lBQ0wsSUFBSSxDQUFDLE1BQU0sQ0FDUCxDQUFDLEdBQUcsRUFBRSxLQUFLLEVBQUUsVUFBVSxFQUFFLEVBQUUsQ0FDdkIsU0FBUyxHQUFHLFFBQVE7Z0JBQ3BCLENBQUMsU0FBUyxLQUFLLFFBQVEsSUFBSSxVQUFVLEdBQUcsU0FBUyxDQUFDO2dCQUM5QyxDQUFDLENBQUMsR0FBRyxHQUFHLEtBQUs7Z0JBQ2IsQ0FBQyxDQUFDLEdBQUcsRUFDYixDQUFDLENB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QyxHQUFHLENBQUMsR0FBRyxNQUFNLEdBQUcsWUFBWSxDQUFDO1lBRXRFLElBQUksU0FBUyxHQUFHLE1BQU0sSUFBSSxHQUFHLEtBQUssVUFBVSxFQUFFO2dCQUMxQyxRQUFRLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQztnQkFDdEUsUUFBUSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUNuQixVQUFVLEVBQ1YsSUFBSSxDQUFDLGlCQUFpQixDQUFDLE1BQU0sR0FBRyxZQUFZLEdBQUcsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUM3RCxDQUFDO2FBQ0w7U0FDSjtRQUVELFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNwQyxRQUFRLENBQUMsd0JBQXdCLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1FBQzFFLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUM7SUFDeEMsQ0FBQztDQUNKO0FBeEhHO0lBREMsT0FBTztvRUFHUCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Q2RrVmlydHVhbFNjcm9sbFZpZXdwb3J0LCBWaXJ0dWFsU2Nyb2xsU3RyYXRlZ3l9IGZyb20gJ0Bhbmd1bGFyL2Nkay9zY3JvbGxpbmcnO1xuaW1wb3J0IHtNT05USFNfSU5fWUVBUiwgdHVpUHVyZSwgVHVpU2Nyb2xsU2VydmljZX0gZnJvbSAnQHRhaWdhLXVpL2Nkayc7XG5pbXBvcnQge09ic2VydmFibGUsIFN1YmplY3R9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtkaXN0aW5jdFVudGlsQ2hhbmdlZCwgdGFrZVVudGlsfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7XG4gICAgQU5EUk9JRF9DWUNMRSxcbiAgICBCVUZGRVIsXG4gICAgSU9TX0NZQ0xFLFxuICAgIFJBTkdFLFxuICAgIFlFQVJMWV9DWUNMRSxcbn0gZnJvbSAnLi9tb2JpbGUtY2FsZW5kYXIuY29uc3QnO1xuXG5jb25zdCBBTkRST0lEX0NZQ0xFX0hFSUdIVCA9IHJlZHVjZUN5Y2xlKEFORFJPSURfQ1lDTEUpO1xuY29uc3QgSU9TX0NZQ0xFX0hFSUdIVCA9IHJlZHVjZUN5Y2xlKElPU19DWUNMRSk7XG5cbmZ1bmN0aW9uIHJlZHVjZUN5Y2xlKFxuICAgIGN5Y2xlOiBSZWFkb25seUFycmF5PHJlYWRvbmx5IG51bWJlcltdPixcbiAgICBsYXN0WWVhcjogbnVtYmVyID0gMjgsXG4gICAgbGFzdE1vbnRoOiBudW1iZXIgPSAxMixcbik6IG51bWJlciB7XG4gICAgcmV0dXJuIGN5Y2xlLnJlZHVjZShcbiAgICAgICAgKHRvdGFsLCB5ZWFyLCB5ZWFySW5kZXgpID0+XG4gICAgICAgICAgICB5ZWFySW5kZXggPD0gbGFzdFllYXJcbiAgICAgICAgICAgICAgICA/IHRvdGFsICtcbiAgICAgICAgICAgICAgICAgIHllYXIucmVkdWNlKFxuICAgICAgICAgICAgICAgICAgICAgIChzdW0sIG1vbnRoLCBtb250aEluZGV4KSA9PlxuICAgICAgICAgICAgICAgICAgICAgICAgICB5ZWFySW5kZXggPCBsYXN0WWVhciB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgICAoeWVhckluZGV4ID09PSBsYXN0WWVhciAmJiBtb250aEluZGV4IDwgbGFzdE1vbnRoKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBzdW0gKyBtb250aFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBzdW0sXG4gICAgICAgICAgICAgICAgICAgICAgMCxcbiAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICA6IHRvdGFsLFxuICAgICAgICAwLFxuICAgICk7XG59XG5cbi8qKlxuICogVGhpcyBzY3JvbGwgc3RyYXRlZ3kgaXMgaGFyZCB3aXJlZCB3aXRoIHN0eWxlcyBmb3IgaU9TIGFuZCBBbmRyb2lkLlxuICogSXQgaXMgZGVwZW5kZW50IG9uIG1vbnRoIGhlaWdodCBvbiB0aG9zZSBwbGF0Zm9ybXMgYW5kIGlzIGRlc2lnbmVkIHRvXG4gKiB3b3JrIGZvciB7QGxpbmsgVHVpTW9iaWxlQ2FsZW5kYXJDb21wb25lbnR9IHdpdGggeWVhcnMgMTkwNiB0byAyMTAyXG4gKi9cbmV4cG9ydCBjbGFzcyBUdWlNb2JpbGVDYWxlbmRhclN0cmF0ZWd5IGltcGxlbWVudHMgVmlydHVhbFNjcm9sbFN0cmF0ZWd5IHtcbiAgICBwcml2YXRlIHJlYWRvbmx5IGluZGV4JCA9IG5ldyBTdWJqZWN0PG51bWJlcj4oKTtcblxuICAgIHByaXZhdGUgdmlld3BvcnQ6IENka1ZpcnR1YWxTY3JvbGxWaWV3cG9ydCB8IG51bGwgPSBudWxsO1xuXG4gICAgcHJpdmF0ZSByZWFkb25seSBkZXN0cm95JCA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSByZWFkb25seSBpc0lvczogYm9vbGVhbixcbiAgICAgICAgcHJpdmF0ZSByZWFkb25seSBzY3JvbGxTZXJ2aWNlOiBUdWlTY3JvbGxTZXJ2aWNlLFxuICAgICkge31cblxuICAgIEB0dWlQdXJlXG4gICAgZ2V0IHNjcm9sbGVkSW5kZXhDaGFuZ2UoKTogT2JzZXJ2YWJsZTxudW1iZXI+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaW5kZXgkLnBpcGUoZGlzdGluY3RVbnRpbENoYW5nZWQoKSk7XG4gICAgfVxuXG4gICAgYXR0YWNoKHZpZXdwb3J0OiBDZGtWaXJ0dWFsU2Nyb2xsVmlld3BvcnQpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgY3ljbGUgPSB0aGlzLmlzSW9zID8gSU9TX0NZQ0xFX0hFSUdIVCA6IEFORFJPSURfQ1lDTEVfSEVJR0hUO1xuXG4gICAgICAgIHRoaXMudmlld3BvcnQgPSB2aWV3cG9ydDtcbiAgICAgICAgdGhpcy52aWV3cG9ydC5zZXRUb3RhbENvbnRlbnRTaXplKGN5Y2xlICogNyk7XG4gICAgICAgIHRoaXMudXBkYXRlUmVuZGVyZWRSYW5nZSh0aGlzLnZpZXdwb3J0KTtcbiAgICB9XG5cbiAgICBkZXRhY2goKTogdm9pZCB7XG4gICAgICAgIHRoaXMuaW5kZXgkLmNvbXBsZXRlKCk7XG4gICAgICAgIHRoaXMudmlld3BvcnQgPSBudWxsO1xuICAgICAgICB0aGlzLmRlc3Ryb3kkLm5leHQoKTtcbiAgICAgICAgdGhpcy5kZXN0cm95JC5jb21wbGV0ZSgpO1xuICAgIH1cblxuICAgIG9uQ29udGVudFNjcm9sbGVkKCk6IHZvaWQge1xuICAgICAgICBpZiAodGhpcy52aWV3cG9ydCkge1xuICAgICAgICAgICAgdGhpcy51cGRhdGVSZW5kZXJlZFJhbmdlKHRoaXMudmlld3BvcnQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqIFRoZXNlIGRvIG5vdCBtYXR0ZXIgZm9yIHRoaXMgY2FzZSAqL1xuICAgIG9uRGF0YUxlbmd0aENoYW5nZWQoKTogdm9pZCB7fVxuICAgIG9uQ29udGVudFJlbmRlcmVkKCk6IHZvaWQge31cbiAgICBvblJlbmRlcmVkT2Zmc2V0Q2hhbmdlZCgpOiB2b2lkIHt9XG5cbiAgICBzY3JvbGxUb0luZGV4KGluZGV4OiBudW1iZXIsIGJlaGF2aW9yOiBTY3JvbGxCZWhhdmlvcik6IHZvaWQge1xuICAgICAgICBpZiAoIXRoaXMudmlld3BvcnQpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHNjcm9sbFRvcCA9IHRoaXMuZ2V0T2Zmc2V0Rm9ySW5kZXgoaW5kZXgpO1xuXG4gICAgICAgIGlmIChiZWhhdmlvciAhPT0gJ3Ntb290aCcpIHtcbiAgICAgICAgICAgIHRoaXMudmlld3BvcnQuc2Nyb2xsVG9PZmZzZXQoc2Nyb2xsVG9wLCBiZWhhdmlvcik7XG5cbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuc2Nyb2xsU2VydmljZVxuICAgICAgICAgICAgLnNjcm9sbCQodGhpcy52aWV3cG9ydC5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQsIHNjcm9sbFRvcClcbiAgICAgICAgICAgIC5waXBlKHRha2VVbnRpbCh0aGlzLmRlc3Ryb3kkKSlcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldE9mZnNldEZvckluZGV4KGluZGV4OiBudW1iZXIpOiBudW1iZXIge1xuICAgICAgICBjb25zdCBtb250aCA9IGluZGV4ICUgTU9OVEhTX0lOX1lFQVI7XG4gICAgICAgIGNvbnN0IHllYXIgPSAoaW5kZXggLSBtb250aCkgLyBNT05USFNfSU5fWUVBUjtcblxuICAgICAgICByZXR1cm4gdGhpcy5jb21wdXRlSGVpZ2h0KHllYXIsIG1vbnRoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldEluZGV4Rm9yT2Zmc2V0KG9mZnNldDogbnVtYmVyKTogbnVtYmVyIHtcbiAgICAgICAgY29uc3QgY3ljbGUgPSB0aGlzLmlzSW9zID8gSU9TX0NZQ0xFIDogQU5EUk9JRF9DWUNMRTtcbiAgICAgICAgY29uc3QgY3ljbGVIZWlnaHQgPSB0aGlzLmlzSW9zID8gSU9TX0NZQ0xFX0hFSUdIVCA6IEFORFJPSURfQ1lDTEVfSEVJR0hUO1xuICAgICAgICBjb25zdCByZW1haW5kZXIgPSBvZmZzZXQgJSBjeWNsZUhlaWdodDtcbiAgICAgICAgY29uc3QgeWVhcnMgPSAoKG9mZnNldCAtIHJlbWFpbmRlcikgLyBjeWNsZUhlaWdodCkgKiBZRUFSTFlfQ1lDTEU7XG5cbiAgICAgICAgbGV0IGFjY3VtdWxhdG9yID0gMDtcblxuICAgICAgICBmb3IgKGxldCB5ZWFyID0gMDsgeWVhciA8IGN5Y2xlLmxlbmd0aDsgeWVhcisrKSB7XG4gICAgICAgICAgICBmb3IgKGxldCBtb250aCA9IDA7IG1vbnRoIDwgY3ljbGVbeWVhcl0ubGVuZ3RoOyBtb250aCsrKSB7XG4gICAgICAgICAgICAgICAgYWNjdW11bGF0b3IgKz0gY3ljbGVbeWVhcl1bbW9udGhdO1xuXG4gICAgICAgICAgICAgICAgaWYgKGFjY3VtdWxhdG9yIC0gY3ljbGVbeWVhcl1bbW9udGhdIC8gMiA+IHJlbWFpbmRlcikge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gTWF0aC5tYXgoKHllYXJzICsgeWVhcikgKiBNT05USFNfSU5fWUVBUiArIG1vbnRoLCAwKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gUkFOR0U7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjb21wdXRlSGVpZ2h0KHllYXI6IG51bWJlciwgbW9udGg/OiBudW1iZXIpOiBudW1iZXIge1xuICAgICAgICBjb25zdCBjeWNsZSA9IHRoaXMuaXNJb3MgPyBJT1NfQ1lDTEUgOiBBTkRST0lEX0NZQ0xFO1xuICAgICAgICBjb25zdCByZW1haW5kZXIgPSB5ZWFyICUgWUVBUkxZX0NZQ0xFO1xuICAgICAgICBjb25zdCByZW1haW5kZXJIZWlnaHQgPSByZWR1Y2VDeWNsZShjeWNsZSwgcmVtYWluZGVyLCBtb250aCk7XG4gICAgICAgIGNvbnN0IGZ1bGxDeWNsZXMgPSAoeWVhciAtIHJlbWFpbmRlcikgLyBZRUFSTFlfQ1lDTEU7XG4gICAgICAgIGNvbnN0IGZ1bGxDeWNsZXNIZWlnaHQgPSB0aGlzLmlzSW9zXG4gICAgICAgICAgICA/IGZ1bGxDeWNsZXMgKiBJT1NfQ1lDTEVfSEVJR0hUXG4gICAgICAgICAgICA6IGZ1bGxDeWNsZXMgKiBBTkRST0lEX0NZQ0xFX0hFSUdIVDtcblxuICAgICAgICByZXR1cm4gZnVsbEN5Y2xlc0hlaWdodCArIHJlbWFpbmRlckhlaWdodDtcbiAgICB9XG5cbiAgICBwcml2YXRlIHVwZGF0ZVJlbmRlcmVkUmFuZ2Uodmlld3BvcnQ6IENka1ZpcnR1YWxTY3JvbGxWaWV3cG9ydCk6IHZvaWQge1xuICAgICAgICBjb25zdCBvZmZzZXQgPSB2aWV3cG9ydC5tZWFzdXJlU2Nyb2xsT2Zmc2V0KCk7XG4gICAgICAgIGNvbnN0IHtzdGFydCwgZW5kfSA9IHZpZXdwb3J0LmdldFJlbmRlcmVkUmFuZ2UoKTtcbiAgICAgICAgY29uc3Qgdmlld3BvcnRTaXplID0gdmlld3BvcnQuZ2V0Vmlld3BvcnRTaXplKCk7XG4gICAgICAgIGNvbnN0IGRhdGFMZW5ndGggPSB2aWV3cG9ydC5nZXREYXRhTGVuZ3RoKCk7XG4gICAgICAgIGNvbnN0IG5ld1JhbmdlID0ge3N0YXJ0LCBlbmR9O1xuICAgICAgICBjb25zdCBmaXJzdFZpc2libGVJbmRleCA9IHRoaXMuZ2V0SW5kZXhGb3JPZmZzZXQob2Zmc2V0KTtcbiAgICAgICAgY29uc3Qgc3RhcnRCdWZmZXIgPSBvZmZzZXQgLSB0aGlzLmdldE9mZnNldEZvckluZGV4KHN0YXJ0KTtcblxuICAgICAgICBpZiAoc3RhcnRCdWZmZXIgPCBCVUZGRVIgJiYgc3RhcnQgIT09IDApIHtcbiAgICAgICAgICAgIG5ld1JhbmdlLnN0YXJ0ID0gTWF0aC5tYXgoMCwgdGhpcy5nZXRJbmRleEZvck9mZnNldChvZmZzZXQgLSBCVUZGRVIgKiAyKSk7XG4gICAgICAgICAgICBuZXdSYW5nZS5lbmQgPSBNYXRoLm1pbihcbiAgICAgICAgICAgICAgICBkYXRhTGVuZ3RoLFxuICAgICAgICAgICAgICAgIHRoaXMuZ2V0SW5kZXhGb3JPZmZzZXQob2Zmc2V0ICsgdmlld3BvcnRTaXplICsgQlVGRkVSKSxcbiAgICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zdCBlbmRCdWZmZXIgPSB0aGlzLmdldE9mZnNldEZvckluZGV4KGVuZCkgLSBvZmZzZXQgLSB2aWV3cG9ydFNpemU7XG5cbiAgICAgICAgICAgIGlmIChlbmRCdWZmZXIgPCBCVUZGRVIgJiYgZW5kICE9PSBkYXRhTGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgbmV3UmFuZ2Uuc3RhcnQgPSBNYXRoLm1heCgwLCB0aGlzLmdldEluZGV4Rm9yT2Zmc2V0KG9mZnNldCAtIEJVRkZFUikpO1xuICAgICAgICAgICAgICAgIG5ld1JhbmdlLmVuZCA9IE1hdGgubWluKFxuICAgICAgICAgICAgICAgICAgICBkYXRhTGVuZ3RoLFxuICAgICAgICAgICAgICAgICAgICB0aGlzLmdldEluZGV4Rm9yT2Zmc2V0KG9mZnNldCArIHZpZXdwb3J0U2l6ZSArIEJVRkZFUiAqIDIpLFxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICB2aWV3cG9ydC5zZXRSZW5kZXJlZFJhbmdlKG5ld1JhbmdlKTtcbiAgICAgICAgdmlld3BvcnQuc2V0UmVuZGVyZWRDb250ZW50T2Zmc2V0KHRoaXMuZ2V0T2Zmc2V0Rm9ySW5kZXgobmV3UmFuZ2Uuc3RhcnQpKTtcbiAgICAgICAgdGhpcy5pbmRleCQubmV4dChmaXJzdFZpc2libGVJbmRleCk7XG4gICAgfVxufVxuIl19