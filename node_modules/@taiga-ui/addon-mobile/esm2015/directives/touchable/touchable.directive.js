import { Directive, ElementRef, Inject, Input, Optional, Renderer2, Self, } from '@angular/core';
import { tuiFindTouchIndex } from '@taiga-ui/addon-mobile/utils';
import { TUI_IS_IOS, TuiDestroyService, tuiTypedFromEvent } from '@taiga-ui/cdk';
import { TUI_ELEMENT_REF } from '@taiga-ui/core';
import { race } from 'rxjs';
import { filter, map, switchMap, take, takeUntil, tap } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@taiga-ui/cdk";
const STYLE = {
    transform: 'scale(0.95)',
    opacity: '0.6',
    background: 'rgba(146, 153, 162, 0.12)',
};
export class TuiTouchableDirective {
    constructor(el, isIos, { nativeElement }, renderer, destroy$) {
        this.tuiTouchable = '';
        if (!isIos) {
            return;
        }
        const element = (el === null || el === void 0 ? void 0 : el.nativeElement) || nativeElement;
        tuiTypedFromEvent(element, 'touchstart', { passive: true })
            .pipe(tap(() => {
            this.onTouchStart(renderer, element);
        }), map(({ touches }) => touches[touches.length - 1].identifier), switchMap(identifier => race(tuiTypedFromEvent(element, 'touchmove', { passive: true }).pipe(filter(({ touches }) => this.hasTouchLeft(element, touches, identifier))), tuiTypedFromEvent(element, 'touchend')).pipe(take(1))), takeUntil(destroy$))
            .subscribe(() => {
            renderer.removeStyle(element, 'transform');
            renderer.removeStyle(element, 'opacity');
            renderer.removeStyle(element, 'background');
        });
    }
    get style() {
        return this.tuiTouchable || 'transform';
    }
    hasTouchLeft(element, touches, identifier) {
        const { ownerDocument } = element;
        const id = tuiFindTouchIndex(touches, identifier);
        if (!ownerDocument || id === -1) {
            return true;
        }
        const { clientX, clientY } = touches[id];
        return !element.contains(ownerDocument.elementFromPoint(clientX, clientY));
    }
    onTouchStart(renderer, element) {
        if (this.style !== 'transform') {
            renderer.removeStyle(element, 'transition');
        }
        else {
            renderer.setStyle(element, 'transition', 'transform 0.2s');
        }
        renderer.setStyle(element, this.style, STYLE[this.style]);
    }
}
TuiTouchableDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.17", ngImport: i0, type: TuiTouchableDirective, deps: [{ token: TUI_ELEMENT_REF, optional: true }, { token: TUI_IS_IOS }, { token: ElementRef }, { token: Renderer2 }, { token: TuiDestroyService, self: true }], target: i0.ɵɵFactoryTarget.Directive });
TuiTouchableDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "12.2.17", type: TuiTouchableDirective, selector: "[tuiTouchable]", inputs: { tuiTouchable: "tuiTouchable" }, providers: [TuiDestroyService], ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.17", ngImport: i0, type: TuiTouchableDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: '[tuiTouchable]',
                    providers: [TuiDestroyService],
                }]
        }], ctorParameters: function () { return [{ type: i0.ElementRef, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: [TUI_ELEMENT_REF]
                }] }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [TUI_IS_IOS]
                }] }, { type: i0.ElementRef, decorators: [{
                    type: Inject,
                    args: [ElementRef]
                }] }, { type: i0.Renderer2, decorators: [{
                    type: Inject,
                    args: [Renderer2]
                }] }, { type: i1.TuiDestroyService, decorators: [{
                    type: Self
                }, {
                    type: Inject,
                    args: [TuiDestroyService]
                }] }]; }, propDecorators: { tuiTouchable: [{
                type: Input
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG91Y2hhYmxlLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2FkZG9uLW1vYmlsZS9kaXJlY3RpdmVzL3RvdWNoYWJsZS90b3VjaGFibGUuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDSCxTQUFTLEVBQ1QsVUFBVSxFQUNWLE1BQU0sRUFDTixLQUFLLEVBQ0wsUUFBUSxFQUNSLFNBQVMsRUFDVCxJQUFJLEdBQ1AsTUFBTSxlQUFlLENBQUM7QUFFdkIsT0FBTyxFQUFDLGlCQUFpQixFQUFDLE1BQU0sOEJBQThCLENBQUM7QUFDL0QsT0FBTyxFQUFDLFVBQVUsRUFBRSxpQkFBaUIsRUFBRSxpQkFBaUIsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUMvRSxPQUFPLEVBQUMsZUFBZSxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFDL0MsT0FBTyxFQUFDLElBQUksRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUMxQixPQUFPLEVBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQzs7O0FBRTVFLE1BQU0sS0FBSyxHQUFHO0lBQ1YsU0FBUyxFQUFFLGFBQWE7SUFDeEIsT0FBTyxFQUFFLEtBQUs7SUFDZCxVQUFVLEVBQUUsMkJBQTJCO0NBQ2pDLENBQUM7QUFNWCxNQUFNLE9BQU8scUJBQXFCO0lBSTlCLFlBQ3lDLEVBQWtDLEVBQ25ELEtBQWMsRUFDZCxFQUFDLGFBQWEsRUFBMEIsRUFDekMsUUFBbUIsRUFDSCxRQUEyQjtRQVBsRSxpQkFBWSxHQUFzQixFQUFFLENBQUM7UUFTakMsSUFBSSxDQUFDLEtBQUssRUFBRTtZQUNSLE9BQU87U0FDVjtRQUVELE1BQU0sT0FBTyxHQUFHLENBQUEsRUFBRSxhQUFGLEVBQUUsdUJBQUYsRUFBRSxDQUFFLGFBQWEsS0FBSSxhQUFhLENB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akM7OzBCQU1RLFFBQVE7OzBCQUFJLE1BQU07MkJBQUMsZUFBZTs7MEJBQ2xDLE1BQU07MkJBQUMsVUFBVTs7MEJBQ2pCLE1BQU07MkJBQUMsVUFBVTs7MEJBQ2pCLE1BQU07MkJBQUMsU0FBUzs7MEJBQ2hCLElBQUk7OzBCQUFJLE1BQU07MkJBQUMsaUJBQWlCOzRDQVByQyxZQUFZO3NCQURYLEtBQUsiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICAgIERpcmVjdGl2ZSxcbiAgICBFbGVtZW50UmVmLFxuICAgIEluamVjdCxcbiAgICBJbnB1dCxcbiAgICBPcHRpb25hbCxcbiAgICBSZW5kZXJlcjIsXG4gICAgU2VsZixcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1R1aVRvdWNoTW9kZX0gZnJvbSAnQHRhaWdhLXVpL2FkZG9uLW1vYmlsZS90eXBlcyc7XG5pbXBvcnQge3R1aUZpbmRUb3VjaEluZGV4fSBmcm9tICdAdGFpZ2EtdWkvYWRkb24tbW9iaWxlL3V0aWxzJztcbmltcG9ydCB7VFVJX0lTX0lPUywgVHVpRGVzdHJveVNlcnZpY2UsIHR1aVR5cGVkRnJvbUV2ZW50fSBmcm9tICdAdGFpZ2EtdWkvY2RrJztcbmltcG9ydCB7VFVJX0VMRU1FTlRfUkVGfSBmcm9tICdAdGFpZ2EtdWkvY29yZSc7XG5pbXBvcnQge3JhY2V9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtmaWx0ZXIsIG1hcCwgc3dpdGNoTWFwLCB0YWtlLCB0YWtlVW50aWwsIHRhcH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5jb25zdCBTVFlMRSA9IHtcbiAgICB0cmFuc2Zvcm06ICdzY2FsZSgwLjk1KScsXG4gICAgb3BhY2l0eTogJzAuNicsXG4gICAgYmFja2dyb3VuZDogJ3JnYmEoMTQ2LCAxNTMsIDE2MiwgMC4xMiknLFxufSBhcyBjb25zdDtcblxuQERpcmVjdGl2ZSh7XG4gICAgc2VsZWN0b3I6ICdbdHVpVG91Y2hhYmxlXScsXG4gICAgcHJvdmlkZXJzOiBbVHVpRGVzdHJveVNlcnZpY2VdLFxufSlcbmV4cG9ydCBjbGFzcyBUdWlUb3VjaGFibGVEaXJlY3RpdmUge1xuICAgIEBJbnB1dCgpXG4gICAgdHVpVG91Y2hhYmxlOiBUdWlUb3VjaE1vZGUgfCAnJyA9ICcnO1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIEBPcHRpb25hbCgpIEBJbmplY3QoVFVJX0VMRU1FTlRfUkVGKSBlbDogRWxlbWVudFJlZjxIVE1MRWxlbWVudD4gfCBudWxsLFxuICAgICAgICBASW5qZWN0KFRVSV9JU19JT1MpIGlzSW9zOiBib29sZWFuLFxuICAgICAgICBASW5qZWN0KEVsZW1lbnRSZWYpIHtuYXRpdmVFbGVtZW50fTogRWxlbWVudFJlZjxIVE1MRWxlbWVudD4sXG4gICAgICAgIEBJbmplY3QoUmVuZGVyZXIyKSByZW5kZXJlcjogUmVuZGVyZXIyLFxuICAgICAgICBAU2VsZigpIEBJbmplY3QoVHVpRGVzdHJveVNlcnZpY2UpIGRlc3Ryb3kkOiBUdWlEZXN0cm95U2VydmljZSxcbiAgICApIHtcbiAgICAgICAgaWYgKCFpc0lvcykge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZWxlbWVudCA9IGVsPy5uYXRpdmVFbGVtZW50IHx8IG5hdGl2ZUVsZW1lbnQ7XG5cbiAgICAgICAgdHVpVHlwZWRGcm9tRXZlbnQoZWxlbWVudCwgJ3RvdWNoc3RhcnQnLCB7cGFzc2l2ZTogdHJ1ZX0pXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICB0YXAoKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLm9uVG91Y2hTdGFydChyZW5kZXJlciwgZWxlbWVudCk7XG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgbWFwKCh7dG91Y2hlc30pID0+IHRvdWNoZXNbdG91Y2hlcy5sZW5ndGggLSAxXS5pZGVudGlmaWVyKSxcbiAgICAgICAgICAgICAgICBzd2l0Y2hNYXAoaWRlbnRpZmllciA9PlxuICAgICAgICAgICAgICAgICAgICByYWNlKFxuICAgICAgICAgICAgICAgICAgICAgICAgdHVpVHlwZWRGcm9tRXZlbnQoZWxlbWVudCwgJ3RvdWNobW92ZScsIHtwYXNzaXZlOiB0cnVlfSkucGlwZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXIoKHt0b3VjaGVzfSkgPT5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5oYXNUb3VjaExlZnQoZWxlbWVudCwgdG91Y2hlcywgaWRlbnRpZmllciksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgICAgICAgICB0dWlUeXBlZEZyb21FdmVudChlbGVtZW50LCAndG91Y2hlbmQnKSxcbiAgICAgICAgICAgICAgICAgICAgKS5waXBlKHRha2UoMSkpLFxuICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgdGFrZVVudGlsKGRlc3Ryb3kkKSxcbiAgICAgICAgICAgIClcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICAgICAgICAgIHJlbmRlcmVyLnJlbW92ZVN0eWxlKGVsZW1lbnQsICd0cmFuc2Zvcm0nKTtcbiAgICAgICAgICAgICAgICByZW5kZXJlci5yZW1vdmVTdHlsZShlbGVtZW50LCAnb3BhY2l0eScpO1xuICAgICAgICAgICAgICAgIHJlbmRlcmVyLnJlbW92ZVN0eWxlKGVsZW1lbnQsICdiYWNrZ3JvdW5kJyk7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBnZXQgc3R5bGUoKTogVHVpVG91Y2hNb2RlIHtcbiAgICAgICAgcmV0dXJuIHRoaXMudHVpVG91Y2hhYmxlIHx8ICd0cmFuc2Zvcm0nO1xuICAgIH1cblxuICAgIHByaXZhdGUgaGFzVG91Y2hMZWZ0KFxuICAgICAgICBlbGVtZW50OiBIVE1MRWxlbWVudCxcbiAgICAgICAgdG91Y2hlczogVG91Y2hMaXN0LFxuICAgICAgICBpZGVudGlmaWVyOiBudW1iZXIsXG4gICAgKTogYm9vbGVhbiB7XG4gICAgICAgIGNvbnN0IHtvd25lckRvY3VtZW50fSA9IGVsZW1lbnQ7XG4gICAgICAgIGNvbnN0IGlkID0gdHVpRmluZFRvdWNoSW5kZXgodG91Y2hlcywgaWRlbnRpZmllcik7XG5cbiAgICAgICAgaWYgKCFvd25lckRvY3VtZW50IHx8IGlkID09PSAtMSkge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCB7Y2xpZW50WCwgY2xpZW50WX0gPSB0b3VjaGVzW2lkXTtcblxuICAgICAgICByZXR1cm4gIWVsZW1lbnQuY29udGFpbnMob3duZXJEb2N1bWVudC5lbGVtZW50RnJvbVBvaW50KGNsaWVudFgsIGNsaWVudFkpKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uVG91Y2hTdGFydChyZW5kZXJlcjogUmVuZGVyZXIyLCBlbGVtZW50OiBIVE1MRWxlbWVudCk6IHZvaWQge1xuICAgICAgICBpZiAodGhpcy5zdHlsZSAhPT0gJ3RyYW5zZm9ybScpIHtcbiAgICAgICAgICAgIHJlbmRlcmVyLnJlbW92ZVN0eWxlKGVsZW1lbnQsICd0cmFuc2l0aW9uJyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZW5kZXJlci5zZXRTdHlsZShlbGVtZW50LCAndHJhbnNpdGlvbicsICd0cmFuc2Zvcm0gMC4ycycpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmVuZGVyZXIuc2V0U3R5bGUoZWxlbWVudCwgdGhpcy5zdHlsZSwgU1RZTEVbdGhpcy5zdHlsZV0pO1xuICAgIH1cbn1cbiJdfQ==