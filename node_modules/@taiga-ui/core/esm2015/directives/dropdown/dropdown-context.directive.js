import { __decorate } from "tslib";
import { Directive, HostBinding, HostListener, Inject } from '@angular/core';
import { EMPTY_CLIENT_RECT, TUI_IS_IOS, TUI_TOUCH_SUPPORTED, TuiActiveZoneDirective, tuiPointToClientRect, } from '@taiga-ui/cdk';
import { tuiAsDriver, tuiAsRectAccessor, TuiDriver, } from '@taiga-ui/core/abstract';
import { shouldCall } from '@tinkoff/ng-event-plugins';
import { Subject } from 'rxjs';
import * as i0 from "@angular/core";
import * as i1 from "@taiga-ui/cdk";
function activeZoneFilter(target) {
    return !this.activeZone.contains(target);
}
const TAP_DELAY = 700;
const MOVE_THRESHOLD = 15;
export class TuiDropdownContextDirective extends TuiDriver {
    constructor(activeZone, isIOS, isTouch) {
        super(subscriber => this.stream$.subscribe(subscriber));
        this.activeZone = activeZone;
        this.isIOS = isIOS;
        this.isTouch = isTouch;
        this.stream$ = new Subject();
        this.currentRect = EMPTY_CLIENT_RECT;
        this.longTapTimeout = NaN;
        this.type = 'dropdown';
    }
    get userSelect() {
        return this.isTouch ? 'none' : null;
    }
    onContextMenu(x, y) {
        this.currentRect = tuiPointToClientRect(x, y);
        this.stream$.next(true);
    }
    closeDropdown() {
        this.stream$.next(false);
        this.currentRect = EMPTY_CLIENT_RECT;
    }
    onTouchMove(x, y) {
        if (this.isIOS &&
            this.isTouch &&
            this.currentRect !== EMPTY_CLIENT_RECT &&
            Math.hypot(x - this.currentRect.x, y - this.currentRect.y) > MOVE_THRESHOLD) {
            this.onTouchEnd();
        }
    }
    onTouchStart(x, y) {
        if (!this.isIOS || !this.isTouch || this.currentRect !== EMPTY_CLIENT_RECT) {
            return;
        }
        this.currentRect = tuiPointToClientRect(x, y);
        this.longTapTimeout = setTimeout(() => {
            this.stream$.next(true);
        }, TAP_DELAY);
    }
    onTouchEnd() {
        if (this.isIOS && this.isTouch) {
            clearTimeout(this.longTapTimeout);
        }
    }
    getClientRect() {
        return this.currentRect;
    }
}
TuiDropdownContextDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.17", ngImport: i0, type: TuiDropdownContextDirective, deps: [{ token: TuiActiveZoneDirective }, { token: TUI_IS_IOS }, { token: TUI_TOUCH_SUPPORTED }], target: i0.ɵɵFactoryTarget.Directive });
TuiDropdownContextDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "12.2.17", type: TuiDropdownContextDirective, selector: "[tuiDropdown][tuiDropdownContext]", host: { listeners: { "contextmenu.prevent.stop": "onContextMenu($event.clientX,$event.clientY)", "document:click.silent": "closeDropdown($event.target)", "document:contextmenu.capture.silent": "closeDropdown($event.target)", "document:keydown.esc": "closeDropdown($event.currentTarget)", "touchmove.silent.passive": "onTouchMove($event.touches[0].clientX,$event.touches[0].clientY)", "touchstart.silent.passive": "onTouchStart($event.touches[0].clientX,$event.touches[0].clientY)", "touchend.silent.passive": "onTouchEnd()", "touchcancel.silent.passive": "onTouchEnd()" }, properties: { "style.user-select": "this.userSelect", "style.-webkit-touch-callout": "this.userSelect", "style.-webkit-user-select": "this.userSelect" } }, providers: [
        TuiActiveZoneDirective,
        tuiAsDriver(TuiDropdownContextDirective),
        tuiAsRectAccessor(TuiDropdownContextDirective),
    ], usesInheritance: true, ngImport: i0 });
__decorate([
    shouldCall(activeZoneFilter)
], TuiDropdownContextDirective.prototype, "closeDropdown", null);
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.17", ngImport: i0, type: TuiDropdownContextDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: '[tuiDropdown][tuiDropdownContext]',
                    providers: [
                        TuiActiveZoneDirective,
                        tuiAsDriver(TuiDropdownContextDirective),
                        tuiAsRectAccessor(TuiDropdownContextDirective),
                    ],
                }]
        }], ctorParameters: function () { return [{ type: i1.TuiActiveZoneDirective, decorators: [{
                    type: Inject,
                    args: [TuiActiveZoneDirective]
                }] }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [TUI_IS_IOS]
                }] }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [TUI_TOUCH_SUPPORTED]
                }] }]; }, propDecorators: { userSelect: [{
                type: HostBinding,
                args: ['style.user-select']
            }, {
                type: HostBinding,
                args: ['style.-webkit-touch-callout']
            }, {
                type: HostBinding,
                args: ['style.-webkit-user-select']
            }], onContextMenu: [{
                type: HostListener,
                args: ['contextmenu.prevent.stop', ['$event.clientX', '$event.clientY']]
            }], closeDropdown: [{
                type: HostListener,
                args: ['document:click.silent', ['$event.target']]
            }, {
                type: HostListener,
                args: ['document:contextmenu.capture.silent', ['$event.target']]
            }, {
                type: HostListener,
                args: ['document:keydown.esc', ['$event.currentTarget']]
            }], onTouchMove: [{
                type: HostListener,
                args: ['touchmove.silent.passive', [
                        '$event.touches[0].clientX',
                        '$event.touches[0].clientY',
                    ]]
            }], onTouchStart: [{
                type: HostListener,
                args: ['touchstart.silent.passive', [
                        '$event.touches[0].clientX',
                        '$event.touches[0].clientY',
                    ]]
            }], onTouchEnd: [{
                type: HostListener,
                args: ['touchend.silent.passive']
            }, {
                type: HostListener,
                args: ['touchcancel.silent.passive']
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHJvcGRvd24tY29udGV4dC5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9jb3JlL2RpcmVjdGl2ZXMvZHJvcGRvd24vZHJvcGRvd24tY29udGV4dC5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBQyxTQUFTLEVBQUUsV0FBVyxFQUFFLFlBQVksRUFBRSxNQUFNLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFDM0UsT0FBTyxFQUNILGlCQUFpQixFQUNqQixVQUFVLEVBQ1YsbUJBQW1CLEVBQ25CLHNCQUFzQixFQUN0QixvQkFBb0IsR0FDdkIsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUNILFdBQVcsRUFDWCxpQkFBaUIsRUFDakIsU0FBUyxHQUVaLE1BQU0seUJBQXlCLENBQUM7QUFDakMsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLDJCQUEyQixDQUFDO0FBQ3JELE9BQU8sRUFBQyxPQUFPLEVBQUMsTUFBTSxNQUFNLENBQUM7OztBQUU3QixTQUFTLGdCQUFnQixDQUFvQyxNQUFlO0lBQ3hFLE9BQU8sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUM3QyxDQUFDO0FBRUQsTUFBTSxTQUFTLEdBQUcsR0FBRyxDQUFDO0FBQ3RCLE1BQU0sY0FBYyxHQUFHLEVBQUUsQ0FBQztBQVUxQixNQUFNLE9BQU8sMkJBQTRCLFNBQVEsU0FBUztJQVF0RCxZQUVhLFVBQWtDLEVBRWxDLEtBQWMsRUFFZCxPQUFnQjtRQUV6QixLQUFLLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO1FBTi9DLGVBQVUsR0FBVixVQUFVLENBQXdCO1FBRWxDLFVBQUssR0FBTCxLQUFLLENBQVM7UUFFZCxZQUFPLEdBQVAsT0FBTyxDQUFTO1FB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RSxDQUFDLGdCQUFnQixFQUFFLGdCQUFnQixDQUFDO2dCQVU5RSxhQUFhO3NCQUhaLFlBQVk7dUJBQUMsdUJBQXVCLEVBQUUsQ0FBQyxlQUFlLENBQUM7O3NCQUN2RCxZQUFZO3VCQUFDLHFDQUFxQyxFQUFFLENBQUMsZUFBZSxDQUFDOztzQkFDckUsWUFBWTt1QkFBQyxzQkFBc0IsRUFBRSxDQUFDLHNCQUFzQixDQUFDO2dCQVU5RCxXQUFXO3NCQUpWLFlBQVk7dUJBQUMsMEJBQTBCLEVBQUU7d0JBQ3RDLDJCQUEyQjt3QkFDM0IsMkJBQTJCO3FCQUM5QjtnQkFnQkQsWUFBWTtzQkFKWCxZQUFZO3VCQUFDLDJCQUEyQixFQUFFO3dCQUN2QywyQkFBMkI7d0JBQzNCLDJCQUEyQjtxQkFDOUI7Z0JBY0QsVUFBVTtzQkFGVCxZQUFZO3VCQUFDLHlCQUF5Qjs7c0JBQ3RDLFlBQVk7dUJBQUMsNEJBQTRCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtEaXJlY3RpdmUsIEhvc3RCaW5kaW5nLCBIb3N0TGlzdGVuZXIsIEluamVjdH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICAgIEVNUFRZX0NMSUVOVF9SRUNULFxuICAgIFRVSV9JU19JT1MsXG4gICAgVFVJX1RPVUNIX1NVUFBPUlRFRCxcbiAgICBUdWlBY3RpdmVab25lRGlyZWN0aXZlLFxuICAgIHR1aVBvaW50VG9DbGllbnRSZWN0LFxufSBmcm9tICdAdGFpZ2EtdWkvY2RrJztcbmltcG9ydCB7XG4gICAgdHVpQXNEcml2ZXIsXG4gICAgdHVpQXNSZWN0QWNjZXNzb3IsXG4gICAgVHVpRHJpdmVyLFxuICAgIFR1aVJlY3RBY2Nlc3Nvcixcbn0gZnJvbSAnQHRhaWdhLXVpL2NvcmUvYWJzdHJhY3QnO1xuaW1wb3J0IHtzaG91bGRDYWxsfSBmcm9tICdAdGlua29mZi9uZy1ldmVudC1wbHVnaW5zJztcbmltcG9ydCB7U3ViamVjdH0gZnJvbSAncnhqcyc7XG5cbmZ1bmN0aW9uIGFjdGl2ZVpvbmVGaWx0ZXIodGhpczogVHVpRHJvcGRvd25Db250ZXh0RGlyZWN0aXZlLCB0YXJnZXQ6IEVsZW1lbnQpOiBib29sZWFuIHtcbiAgICByZXR1cm4gIXRoaXMuYWN0aXZlWm9uZS5jb250YWlucyh0YXJnZXQpO1xufVxuXG5jb25zdCBUQVBfREVMQVkgPSA3MDA7XG5jb25zdCBNT1ZFX1RIUkVTSE9MRCA9IDE1O1xuXG5ARGlyZWN0aXZlKHtcbiAgICBzZWxlY3RvcjogJ1t0dWlEcm9wZG93bl1bdHVpRHJvcGRvd25Db250ZXh0XScsXG4gICAgcHJvdmlkZXJzOiBbXG4gICAgICAgIFR1aUFjdGl2ZVpvbmVEaXJlY3RpdmUsXG4gICAgICAgIHR1aUFzRHJpdmVyKFR1aURyb3Bkb3duQ29udGV4dERpcmVjdGl2ZSksXG4gICAgICAgIHR1aUFzUmVjdEFjY2Vzc29yKFR1aURyb3Bkb3duQ29udGV4dERpcmVjdGl2ZSksXG4gICAgXSxcbn0pXG5leHBvcnQgY2xhc3MgVHVpRHJvcGRvd25Db250ZXh0RGlyZWN0aXZlIGV4dGVuZHMgVHVpRHJpdmVyIGltcGxlbWVudHMgVHVpUmVjdEFjY2Vzc29yIHtcbiAgICBwcml2YXRlIHJlYWRvbmx5IHN0cmVhbSQgPSBuZXcgU3ViamVjdDxib29sZWFuPigpO1xuXG4gICAgcHJpdmF0ZSBjdXJyZW50UmVjdCA9IEVNUFRZX0NMSUVOVF9SRUNUO1xuICAgIHByaXZhdGUgbG9uZ1RhcFRpbWVvdXQ6IGFueSA9IE5hTjtcblxuICAgIHJlYWRvbmx5IHR5cGUgPSAnZHJvcGRvd24nO1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIEBJbmplY3QoVHVpQWN0aXZlWm9uZURpcmVjdGl2ZSlcbiAgICAgICAgcmVhZG9ubHkgYWN0aXZlWm9uZTogVHVpQWN0aXZlWm9uZURpcmVjdGl2ZSxcbiAgICAgICAgQEluamVjdChUVUlfSVNfSU9TKVxuICAgICAgICByZWFkb25seSBpc0lPUzogYm9vbGVhbixcbiAgICAgICAgQEluamVjdChUVUlfVE9VQ0hfU1VQUE9SVEVEKVxuICAgICAgICByZWFkb25seSBpc1RvdWNoOiBib29sZWFuLFxuICAgICkge1xuICAgICAgICBzdXBlcihzdWJzY3JpYmVyID0+IHRoaXMuc3RyZWFtJC5zdWJzY3JpYmUoc3Vic2NyaWJlcikpO1xuICAgIH1cblxuICAgIEBIb3N0QmluZGluZygnc3R5bGUudXNlci1zZWxlY3QnKVxuICAgIEBIb3N0QmluZGluZygnc3R5bGUuLXdlYmtpdC10b3VjaC1jYWxsb3V0JylcbiAgICBASG9zdEJpbmRpbmcoJ3N0eWxlLi13ZWJraXQtdXNlci1zZWxlY3QnKVxuICAgIGdldCB1c2VyU2VsZWN0KCk6IHN0cmluZyB8IG51bGwge1xuICAgICAgICByZXR1cm4gdGhpcy5pc1RvdWNoID8gJ25vbmUnIDogbnVsbDtcbiAgICB9XG5cbiAgICBASG9zdExpc3RlbmVyKCdjb250ZXh0bWVudS5wcmV2ZW50LnN0b3AnLCBbJyRldmVudC5jbGllbnRYJywgJyRldmVudC5jbGllbnRZJ10pXG4gICAgb25Db250ZXh0TWVudSh4OiBudW1iZXIsIHk6IG51bWJlcik6IHZvaWQge1xuICAgICAgICB0aGlzLmN1cnJlbnRSZWN0ID0gdHVpUG9pbnRUb0NsaWVudFJlY3QoeCwgeSk7XG4gICAgICAgIHRoaXMuc3RyZWFtJC5uZXh0KHRydWUpO1xuICAgIH1cblxuICAgIEBzaG91bGRDYWxsKGFjdGl2ZVpvbmVGaWx0ZXIpXG4gICAgQEhvc3RMaXN0ZW5lcignZG9jdW1lbnQ6Y2xpY2suc2lsZW50JywgWyckZXZlbnQudGFyZ2V0J10pXG4gICAgQEhvc3RMaXN0ZW5lcignZG9jdW1lbnQ6Y29udGV4dG1lbnUuY2FwdHVyZS5zaWxlbnQnLCBbJyRldmVudC50YXJnZXQnXSlcbiAgICBASG9zdExpc3RlbmVyKCdkb2N1bWVudDprZXlkb3duLmVzYycsIFsnJGV2ZW50LmN1cnJlbnRUYXJnZXQnXSlcbiAgICBjbG9zZURyb3Bkb3duKCk6IHZvaWQge1xuICAgICAgICB0aGlzLnN0cmVhbSQubmV4dChmYWxzZSk7XG4gICAgICAgIHRoaXMuY3VycmVudFJlY3QgPSBFTVBUWV9DTElFTlRfUkVDVDtcbiAgICB9XG5cbiAgICBASG9zdExpc3RlbmVyKCd0b3VjaG1vdmUuc2lsZW50LnBhc3NpdmUnLCBbXG4gICAgICAgICckZXZlbnQudG91Y2hlc1swXS5jbGllbnRYJyxcbiAgICAgICAgJyRldmVudC50b3VjaGVzWzBdLmNsaWVudFknLFxuICAgIF0pXG4gICAgb25Ub3VjaE1vdmUoeDogbnVtYmVyLCB5OiBudW1iZXIpOiB2b2lkIHtcbiAgICAgICAgaWYgKFxuICAgICAgICAgICAgdGhpcy5pc0lPUyAmJlxuICAgICAgICAgICAgdGhpcy5pc1RvdWNoICYmXG4gICAgICAgICAgICB0aGlzLmN1cnJlbnRSZWN0ICE9PSBFTVBUWV9DTElFTlRfUkVDVCAmJlxuICAgICAgICAgICAgTWF0aC5oeXBvdCh4IC0gdGhpcy5jdXJyZW50UmVjdC54LCB5IC0gdGhpcy5jdXJyZW50UmVjdC55KSA+IE1PVkVfVEhSRVNIT0xEXG4gICAgICAgICkge1xuICAgICAgICAgICAgdGhpcy5vblRvdWNoRW5kKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBASG9zdExpc3RlbmVyKCd0b3VjaHN0YXJ0LnNpbGVudC5wYXNzaXZlJywgW1xuICAgICAgICAnJGV2ZW50LnRvdWNoZXNbMF0uY2xpZW50WCcsXG4gICAgICAgICckZXZlbnQudG91Y2hlc1swXS5jbGllbnRZJyxcbiAgICBdKVxuICAgIG9uVG91Y2hTdGFydCh4OiBudW1iZXIsIHk6IG51bWJlcik6IHZvaWQge1xuICAgICAgICBpZiAoIXRoaXMuaXNJT1MgfHwgIXRoaXMuaXNUb3VjaCB8fCB0aGlzLmN1cnJlbnRSZWN0ICE9PSBFTVBUWV9DTElFTlRfUkVDVCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5jdXJyZW50UmVjdCA9IHR1aVBvaW50VG9DbGllbnRSZWN0KHgsIHkpO1xuICAgICAgICB0aGlzLmxvbmdUYXBUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnN0cmVhbSQubmV4dCh0cnVlKTtcbiAgICAgICAgfSwgVEFQX0RFTEFZKTtcbiAgICB9XG5cbiAgICBASG9zdExpc3RlbmVyKCd0b3VjaGVuZC5zaWxlbnQucGFzc2l2ZScpXG4gICAgQEhvc3RMaXN0ZW5lcigndG91Y2hjYW5jZWwuc2lsZW50LnBhc3NpdmUnKVxuICAgIG9uVG91Y2hFbmQoKTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLmlzSU9TICYmIHRoaXMuaXNUb3VjaCkge1xuICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMubG9uZ1RhcFRpbWVvdXQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZ2V0Q2xpZW50UmVjdCgpOiBDbGllbnRSZWN0IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudFJlY3Q7XG4gICAgfVxufVxuIl19