import { ChangeDetectionStrategy, Component, EventEmitter, HostListener, Inject, Input, Output, } from '@angular/core';
import { TUI_TABLE_SHOW_HIDE_MESSAGE } from '@taiga-ui/addon-table/tokens';
import { TUI_REORDER_OPTIONS } from './reorder.options';
import * as i0 from "@angular/core";
import * as i1 from "@taiga-ui/kit";
import * as i2 from "@taiga-ui/core";
import * as i3 from "@angular/common";
import * as i4 from "rxjs";
export class TuiReorderComponent {
    constructor(options, showHideText$) {
        this.options = options;
        this.showHideText$ = showHideText$;
        this.dragging = false;
        this.enabled = [];
        this.itemsChange = new EventEmitter();
        this.enabledChange = new EventEmitter();
        this.order = new Map();
        this.unsortedItems = [];
    }
    set items(items) {
        if (items.length !== this.unsortedItems.length ||
            !items.every(item => this.unsortedItems.includes(item))) {
            this.unsortedItems = items;
        }
    }
    noop() { }
    onDrag() {
        this.dragging = true;
    }
    onDrop() {
        if (!this.dragging) {
            return;
        }
        this.dragging = false;
        this.updateItems();
    }
    isEnabled(item) {
        return this.enabled.includes(item);
    }
    getIcon(item) {
        return this.isEnabled(item) ? this.options.icons.hide : this.options.icons.show;
    }
    toggle(toggled) {
        this.enabled = this.isEnabled(toggled)
            ? this.enabled.filter(item => item !== toggled)
            : this.enabled.concat(toggled);
        this.updateEnabled();
    }
    move(index, direction) {
        var _a;
        const oldIndex = (_a = this.order.get(index)) !== null && _a !== void 0 ? _a : index;
        if ((!oldIndex && direction < 0) ||
            (oldIndex === this.unsortedItems.length - 1 && direction > 0)) {
            return;
        }
        const newIndex = oldIndex + direction;
        const oldItem = Array.from(this.order.values()).findIndex(item => item === newIndex);
        this.order.set(index, newIndex);
        this.order.set(oldItem, oldIndex);
        this.order = new Map(this.order);
        this.updateItems();
    }
    getSortedItems() {
        const items = new Array(this.unsortedItems.length);
        this.unsortedItems.forEach((item, index) => {
            var _a;
            items[(_a = this.order.get(index)) !== null && _a !== void 0 ? _a : index] = item;
        });
        return items;
    }
    updateItems() {
        this.itemsChange.emit(this.getSortedItems());
        this.updateEnabled();
    }
    updateEnabled() {
        const enabled = this.getSortedItems().filter(item => this.isEnabled(item));
        this.enabled = enabled;
        this.enabledChange.emit(enabled);
    }
}
TuiReorderComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.17", ngImport: i0, type: TuiReorderComponent, deps: [{ token: TUI_REORDER_OPTIONS }, { token: TUI_TABLE_SHOW_HIDE_MESSAGE }], target: i0.ɵɵFactoryTarget.Component });
TuiReorderComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "12.2.17", type: TuiReorderComponent, selector: "tui-reorder", inputs: { items: "items", enabled: "enabled" }, outputs: { itemsChange: "itemsChange", enabledChange: "enabledChange" }, host: { listeners: { "focusout.stop": "noop()", "pointerdown.silent": "onDrag()", "document:pointerup.silent": "onDrop()" } }, ngImport: i0, template: "<tui-tiles\n    class=\"t-wrapper\"\n    [(order)]=\"order\"\n>\n    <tui-tile\n        *ngFor=\"let item of unsortedItems; let index = index\"\n        [style.order]=\"order.get(index)\"\n    >\n        <div class=\"t-item\">\n            <div\n                tuiTileHandle\n                class=\"t-draggable\"\n            >\n                <tui-svg\n                    class=\"t-icon\"\n                    [src]=\"options.icons.drag\"\n                ></tui-svg>\n                {{ item }}\n            </div>\n            <button\n                appearance=\"icon\"\n                size=\"xs\"\n                tuiIconButton\n                type=\"button\"\n                class=\"t-button\"\n                [class.t-button_hidden]=\"!isEnabled(item)\"\n                [icon]=\"getIcon(item)\"\n                [title]=\"showHideText$ | async\"\n                (click)=\"toggle(item)\"\n                (keydown.arrowDown.prevent)=\"move(index, 1)\"\n                (keydown.arrowUp.prevent)=\"move(index, -1)\"\n            ></button>\n        </div>\n    </tui-tile>\n</tui-tiles>\n", styles: [":host{display:block;font:var(--tui-font-text-s);padding:.5rem 0;-webkit-user-select:none;-moz-user-select:none;user-select:none}.t-wrapper{grid-auto-rows:2rem}.t-draggable{cursor:ns-resize;flex:1 1 auto}.t-item{transition-property:background;transition-duration:var(--tui-duration, .3s);transition-timing-function:ease-in-out;display:flex;height:2rem;align-items:center;padding:0 .75rem;background:var(--tui-base-01)}.t-item:hover{background:var(--tui-base-02)}.t-item:hover .t-button{opacity:1}.t-icon{margin-right:.5rem;color:var(--tui-base-05)}.t-button{transition-property:opacity;transition-duration:var(--tui-duration, .3s);transition-timing-function:ease-in-out;margin-left:auto;opacity:0}.t-button_hidden,.t-button:focus{opacity:1}\n"], components: [{ type: i1.TuiTilesComponent, selector: "tui-tiles", inputs: ["debounce", "order"], outputs: ["orderChange"] }, { type: i1.TuiTileComponent, selector: "tui-tile", inputs: ["width", "height"] }, { type: i2.TuiSvgComponent, selector: "tui-svg", inputs: ["src"] }, { type: i2.TuiButtonComponent, selector: "button[tuiButton], button[tuiIconButton], a[tuiButton], a[tuiIconButton]", inputs: ["appearance", "disabled", "icon", "iconRight", "shape", "showLoader", "size"] }], directives: [{ type: i3.NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }, { type: i1.TuiTileHandleDirective, selector: "[tuiTileHandle]" }], pipes: { "async": i3.AsyncPipe }, changeDetection: i0.ChangeDetectionStrategy.OnPush });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.17", ngImport: i0, type: TuiReorderComponent, decorators: [{
            type: Component,
            args: [{
                    selector: 'tui-reorder',
                    templateUrl: './reorder.template.html',
                    styleUrls: ['./reorder.style.less'],
                    changeDetection: ChangeDetectionStrategy.OnPush,
                }]
        }], ctorParameters: function () { return [{ type: undefined, decorators: [{
                    type: Inject,
                    args: [TUI_REORDER_OPTIONS]
                }] }, { type: i4.Observable, decorators: [{
                    type: Inject,
                    args: [TUI_TABLE_SHOW_HIDE_MESSAGE]
                }] }]; }, propDecorators: { items: [{
                type: Input
            }], enabled: [{
                type: Input
            }], itemsChange: [{
                type: Output
            }], enabledChange: [{
                type: Output
            }], noop: [{
                type: HostListener,
                args: ['focusout.stop']
            }], onDrag: [{
                type: HostListener,
                args: ['pointerdown.silent']
            }], onDrop: [{
                type: HostListener,
                args: ['document:pointerup.silent']
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVvcmRlci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9hZGRvbi10YWJsZS9jb21wb25lbnRzL3Jlb3JkZXIvcmVvcmRlci5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9hZGRvbi10YWJsZS9jb21wb25lbnRzL3Jlb3JkZXIvcmVvcmRlci50ZW1wbGF0ZS5odG1sIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDSCx1QkFBdUIsRUFDdkIsU0FBUyxFQUNULFlBQVksRUFDWixZQUFZLEVBQ1osTUFBTSxFQUNOLEtBQUssRUFDTCxNQUFNLEdBQ1QsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFDLDJCQUEyQixFQUFDLE1BQU0sOEJBQThCLENBQUM7QUFHekUsT0FBTyxFQUFDLG1CQUFtQixFQUFvQixNQUFNLG1CQUFtQixDQUFDOzs7Ozs7QUFRekUsTUFBTSxPQUFPLG1CQUFtQjtJQTBCNUIsWUFDMEMsT0FBMEIsRUFDbEIsYUFBaUM7UUFEekMsWUFBTyxHQUFQLE9BQU8sQ0FBbUI7UUFDbEIsa0JBQWEsR0FBYixhQUFhLENBQW9CO1FBM0IzRSxhQUFRLEdBQUcsS0FBSyxDQUFDO1FBYXpCLFlBQU8sR0FBaUIsRUFBRSxDQUFDO1FBR2xCLGdCQUFXLEdBQUcsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUd0QyxrQkFBYSxHQUFHLElBQUksWUFBWSxFQUFPLENBQUM7UUFFakQsVUFBSyxHQUFHLElBQUksR0FBRyxFQUFrQixDQUFDO1FBRWxDLGtCQUFhLEdBQWlCLEVBQUUsQ0FBQztJQUs5QixDQUFDO0lBMUJKLElBQ0ksS0FBSyxDQUFDLEtBQW1CO1FBQ3pCLElBQ0ksS0FBSyxDQUFDLE1BQU0sS0FBSyxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU07WUFDMUMsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsRUFDekQ7WUFDRSxJQUFJLENBQUMsYUFBYSxHQUFHLEtBQUssQ0FBQztTQUM5QjtJQUNMLENBQUM7SUFxQkQsSUFBSSxLQUFVLENBQUM7SUFHZixNQUFNO1FBQ0YsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7SUFDekIsQ0FBQztJQUdELE1BQU07UUFDRixJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNoQixPQUFPO1NBQ1Y7UUFFRCxJQUFJLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQztRQUN0QixJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDdkIsQ0FBQztJQUVELFNBQVMsQ0FBQyxJQUFPO1FBQ2IsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN2QyxDQUFDO0lBRUQsT0FBTyxDQUFDLElBQU87UUFDWCxPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDO0lBQ3BGLENBQUM7SUFFRCxNQUFNLENBQUMsT0FBVTtRQUNiLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUM7WUFDbEMsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxLQUFLLE9BQU8sQ0FBQztZQUMvQyxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFbkMsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ3pCLENBQUM7SUFFRCxJQUFJLENBQUMsS0FBYSxFQUFFLFNBQWlCOztRQUNqQyxNQUFNLFFBQVEsR0FBRyxNQUFBLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxtQ0FBSSxLQUFLLENBQUM7UUFFaEQsSUFDSSxDQUFDLENBQUMsUUFBUSxJQUFJLFNBQVMsR0FBRyxDQUFDLENBQUM7WUFDNUIsQ0FBQyxRQUFRLEtBQUssSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxJQUFJLFNBQVMsR0FBRyxDQUFDLENBQUMsRUFDL0Q7WUFDRSxPQUFPO1NBQ1Y7UUFFRCxNQUFNLFFBQVEsR0FBRyxRQUFRLEdBQUcsU0FBUyxDQUFDO1FBQ3RDLE1BQU0sT0FBTyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FDckQsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLEtBQUssUUFBUSxDQUM1QixDQUFDO1FBRUYsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ2hDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUMsQ0FBQztRQUNsQyxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUVqQyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDdkIsQ0FBQztJQUVPLGNBQWM7UUFDbEIsTUFBTSxLQUFLLEdBQUcsSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUVuRCxJQUFJLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsRUFBRTs7WUFDdkMsS0FBSyxDQUFDLE1BQUEsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLG1DQUFJLEtBQUssQ0FBQyxHQUFHLElBQUksQ0FBQztRQUNqRCxDQUFDLENBQUMsQ0FBQztRQUVILE9BQU8sS0FBSyxDQUFDO0lBQ2pCLENBQUM7SUFFTyxXQUFXO1FBQ2YsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDLENBQUM7UUFDN0MsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ3pCLENBQUM7SUFFTyxhQUFhO1FBQ2pCLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFFM0UsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7UUFDdkIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDckMsQ0FBQzs7aUhBM0dRLG1CQUFtQixrQkEyQmhCLG1CQUFtQixhQUNuQiwyQkFBMkI7cUdBNUI5QixtQkFBbUIsMlNDcEJoQyxrbENBbUNBOzRGRGZhLG1CQUFtQjtrQkFOL0IsU0FBUzttQkFBQztvQkFDUCxRQUFRLEVBQUUsYUFBYTtvQkFDdkIsV0FBVyxFQUFFLHlCQUF5QjtvQkFDdEMsU0FBUyxFQUFFLENBQUMsc0JBQXNCLENBQUM7b0JBQ25DLGVBQWUsRUFBRSx1QkFBdUIsQ0FBQyxNQUFNO2lCQUNsRDs7MEJBNEJRLE1BQU07MkJBQUMsbUJBQW1COzswQkFDMUIsTUFBTTsyQkFBQywyQkFBMkI7NENBeEJuQyxLQUFLO3NCQURSLEtBQUs7Z0JBV04sT0FBTztzQkFETixLQUFLO2dCQUlHLFdBQVc7c0JBRG5CLE1BQU07Z0JBSUUsYUFBYTtzQkFEckIsTUFBTTtnQkFhUCxJQUFJO3NCQURILFlBQVk7dUJBQUMsZUFBZTtnQkFJN0IsTUFBTTtzQkFETCxZQUFZO3VCQUFDLG9CQUFvQjtnQkFNbEMsTUFBTTtzQkFETCxZQUFZO3VCQUFDLDJCQUEyQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gICAgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3ksXG4gICAgQ29tcG9uZW50LFxuICAgIEV2ZW50RW1pdHRlcixcbiAgICBIb3N0TGlzdGVuZXIsXG4gICAgSW5qZWN0LFxuICAgIElucHV0LFxuICAgIE91dHB1dCxcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1RVSV9UQUJMRV9TSE9XX0hJREVfTUVTU0FHRX0gZnJvbSAnQHRhaWdhLXVpL2FkZG9uLXRhYmxlL3Rva2Vucyc7XG5pbXBvcnQge09ic2VydmFibGV9IGZyb20gJ3J4anMnO1xuXG5pbXBvcnQge1RVSV9SRU9SREVSX09QVElPTlMsIFR1aVJlb3JkZXJPcHRpb25zfSBmcm9tICcuL3Jlb3JkZXIub3B0aW9ucyc7XG5cbkBDb21wb25lbnQoe1xuICAgIHNlbGVjdG9yOiAndHVpLXJlb3JkZXInLFxuICAgIHRlbXBsYXRlVXJsOiAnLi9yZW9yZGVyLnRlbXBsYXRlLmh0bWwnLFxuICAgIHN0eWxlVXJsczogWycuL3Jlb3JkZXIuc3R5bGUubGVzcyddLFxuICAgIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoLFxufSlcbmV4cG9ydCBjbGFzcyBUdWlSZW9yZGVyQ29tcG9uZW50PFQ+IHtcbiAgICBwcml2YXRlIGRyYWdnaW5nID0gZmFsc2U7XG5cbiAgICBASW5wdXQoKVxuICAgIHNldCBpdGVtcyhpdGVtczogcmVhZG9ubHkgVFtdKSB7XG4gICAgICAgIGlmIChcbiAgICAgICAgICAgIGl0ZW1zLmxlbmd0aCAhPT0gdGhpcy51bnNvcnRlZEl0ZW1zLmxlbmd0aCB8fFxuICAgICAgICAgICAgIWl0ZW1zLmV2ZXJ5KGl0ZW0gPT4gdGhpcy51bnNvcnRlZEl0ZW1zLmluY2x1ZGVzKGl0ZW0pKVxuICAgICAgICApIHtcbiAgICAgICAgICAgIHRoaXMudW5zb3J0ZWRJdGVtcyA9IGl0ZW1zO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgQElucHV0KClcbiAgICBlbmFibGVkOiByZWFkb25seSBUW10gPSBbXTtcblxuICAgIEBPdXRwdXQoKVxuICAgIHJlYWRvbmx5IGl0ZW1zQ2hhbmdlID0gbmV3IEV2ZW50RW1pdHRlcjxUW10+KCk7XG5cbiAgICBAT3V0cHV0KClcbiAgICByZWFkb25seSBlbmFibGVkQ2hhbmdlID0gbmV3IEV2ZW50RW1pdHRlcjxUW10+KCk7XG5cbiAgICBvcmRlciA9IG5ldyBNYXA8bnVtYmVyLCBudW1iZXI+KCk7XG5cbiAgICB1bnNvcnRlZEl0ZW1zOiByZWFkb25seSBUW10gPSBbXTtcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBASW5qZWN0KFRVSV9SRU9SREVSX09QVElPTlMpIHJlYWRvbmx5IG9wdGlvbnM6IFR1aVJlb3JkZXJPcHRpb25zLFxuICAgICAgICBASW5qZWN0KFRVSV9UQUJMRV9TSE9XX0hJREVfTUVTU0FHRSkgcmVhZG9ubHkgc2hvd0hpZGVUZXh0JDogT2JzZXJ2YWJsZTxzdHJpbmc+LFxuICAgICkge31cblxuICAgIEBIb3N0TGlzdGVuZXIoJ2ZvY3Vzb3V0LnN0b3AnKVxuICAgIG5vb3AoKTogdm9pZCB7fVxuXG4gICAgQEhvc3RMaXN0ZW5lcigncG9pbnRlcmRvd24uc2lsZW50JylcbiAgICBvbkRyYWcoKTogdm9pZCB7XG4gICAgICAgIHRoaXMuZHJhZ2dpbmcgPSB0cnVlO1xuICAgIH1cblxuICAgIEBIb3N0TGlzdGVuZXIoJ2RvY3VtZW50OnBvaW50ZXJ1cC5zaWxlbnQnKVxuICAgIG9uRHJvcCgpOiB2b2lkIHtcbiAgICAgICAgaWYgKCF0aGlzLmRyYWdnaW5nKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmRyYWdnaW5nID0gZmFsc2U7XG4gICAgICAgIHRoaXMudXBkYXRlSXRlbXMoKTtcbiAgICB9XG5cbiAgICBpc0VuYWJsZWQoaXRlbTogVCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5lbmFibGVkLmluY2x1ZGVzKGl0ZW0pO1xuICAgIH1cblxuICAgIGdldEljb24oaXRlbTogVCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLmlzRW5hYmxlZChpdGVtKSA/IHRoaXMub3B0aW9ucy5pY29ucy5oaWRlIDogdGhpcy5vcHRpb25zLmljb25zLnNob3c7XG4gICAgfVxuXG4gICAgdG9nZ2xlKHRvZ2dsZWQ6IFQpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5lbmFibGVkID0gdGhpcy5pc0VuYWJsZWQodG9nZ2xlZClcbiAgICAgICAgICAgID8gdGhpcy5lbmFibGVkLmZpbHRlcihpdGVtID0+IGl0ZW0gIT09IHRvZ2dsZWQpXG4gICAgICAgICAgICA6IHRoaXMuZW5hYmxlZC5jb25jYXQodG9nZ2xlZCk7XG5cbiAgICAgICAgdGhpcy51cGRhdGVFbmFibGVkKCk7XG4gICAgfVxuXG4gICAgbW92ZShpbmRleDogbnVtYmVyLCBkaXJlY3Rpb246IG51bWJlcik6IHZvaWQge1xuICAgICAgICBjb25zdCBvbGRJbmRleCA9IHRoaXMub3JkZXIuZ2V0KGluZGV4KSA/PyBpbmRleDtcblxuICAgICAgICBpZiAoXG4gICAgICAgICAgICAoIW9sZEluZGV4ICYmIGRpcmVjdGlvbiA8IDApIHx8XG4gICAgICAgICAgICAob2xkSW5kZXggPT09IHRoaXMudW5zb3J0ZWRJdGVtcy5sZW5ndGggLSAxICYmIGRpcmVjdGlvbiA+IDApXG4gICAgICAgICkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgbmV3SW5kZXggPSBvbGRJbmRleCArIGRpcmVjdGlvbjtcbiAgICAgICAgY29uc3Qgb2xkSXRlbSA9IEFycmF5LmZyb20odGhpcy5vcmRlci52YWx1ZXMoKSkuZmluZEluZGV4KFxuICAgICAgICAgICAgaXRlbSA9PiBpdGVtID09PSBuZXdJbmRleCxcbiAgICAgICAgKTtcblxuICAgICAgICB0aGlzLm9yZGVyLnNldChpbmRleCwgbmV3SW5kZXgpO1xuICAgICAgICB0aGlzLm9yZGVyLnNldChvbGRJdGVtLCBvbGRJbmRleCk7XG4gICAgICAgIHRoaXMub3JkZXIgPSBuZXcgTWFwKHRoaXMub3JkZXIpO1xuXG4gICAgICAgIHRoaXMudXBkYXRlSXRlbXMoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldFNvcnRlZEl0ZW1zKCk6IFRbXSB7XG4gICAgICAgIGNvbnN0IGl0ZW1zID0gbmV3IEFycmF5KHRoaXMudW5zb3J0ZWRJdGVtcy5sZW5ndGgpO1xuXG4gICAgICAgIHRoaXMudW5zb3J0ZWRJdGVtcy5mb3JFYWNoKChpdGVtLCBpbmRleCkgPT4ge1xuICAgICAgICAgICAgaXRlbXNbdGhpcy5vcmRlci5nZXQoaW5kZXgpID8/IGluZGV4XSA9IGl0ZW07XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBpdGVtcztcbiAgICB9XG5cbiAgICBwcml2YXRlIHVwZGF0ZUl0ZW1zKCk6IHZvaWQge1xuICAgICAgICB0aGlzLml0ZW1zQ2hhbmdlLmVtaXQodGhpcy5nZXRTb3J0ZWRJdGVtcygpKTtcbiAgICAgICAgdGhpcy51cGRhdGVFbmFibGVkKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB1cGRhdGVFbmFibGVkKCk6IHZvaWQge1xuICAgICAgICBjb25zdCBlbmFibGVkID0gdGhpcy5nZXRTb3J0ZWRJdGVtcygpLmZpbHRlcihpdGVtID0+IHRoaXMuaXNFbmFibGVkKGl0ZW0pKTtcblxuICAgICAgICB0aGlzLmVuYWJsZWQgPSBlbmFibGVkO1xuICAgICAgICB0aGlzLmVuYWJsZWRDaGFuZ2UuZW1pdChlbmFibGVkKTtcbiAgICB9XG59XG4iLCI8dHVpLXRpbGVzXG4gICAgY2xhc3M9XCJ0LXdyYXBwZXJcIlxuICAgIFsob3JkZXIpXT1cIm9yZGVyXCJcbj5cbiAgICA8dHVpLXRpbGVcbiAgICAgICAgKm5nRm9yPVwibGV0IGl0ZW0gb2YgdW5zb3J0ZWRJdGVtczsgbGV0IGluZGV4ID0gaW5kZXhcIlxuICAgICAgICBbc3R5bGUub3JkZXJdPVwib3JkZXIuZ2V0KGluZGV4KVwiXG4gICAgPlxuICAgICAgICA8ZGl2IGNsYXNzPVwidC1pdGVtXCI+XG4gICAgICAgICAgICA8ZGl2XG4gICAgICAgICAgICAgICAgdHVpVGlsZUhhbmRsZVxuICAgICAgICAgICAgICAgIGNsYXNzPVwidC1kcmFnZ2FibGVcIlxuICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgIDx0dWktc3ZnXG4gICAgICAgICAgICAgICAgICAgIGNsYXNzPVwidC1pY29uXCJcbiAgICAgICAgICAgICAgICAgICAgW3NyY109XCJvcHRpb25zLmljb25zLmRyYWdcIlxuICAgICAgICAgICAgICAgID48L3R1aS1zdmc+XG4gICAgICAgICAgICAgICAge3sgaXRlbSB9fVxuICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICA8YnV0dG9uXG4gICAgICAgICAgICAgICAgYXBwZWFyYW5jZT1cImljb25cIlxuICAgICAgICAgICAgICAgIHNpemU9XCJ4c1wiXG4gICAgICAgICAgICAgICAgdHVpSWNvbkJ1dHRvblxuICAgICAgICAgICAgICAgIHR5cGU9XCJidXR0b25cIlxuICAgICAgICAgICAgICAgIGNsYXNzPVwidC1idXR0b25cIlxuICAgICAgICAgICAgICAgIFtjbGFzcy50LWJ1dHRvbl9oaWRkZW5dPVwiIWlzRW5hYmxlZChpdGVtKVwiXG4gICAgICAgICAgICAgICAgW2ljb25dPVwiZ2V0SWNvbihpdGVtKVwiXG4gICAgICAgICAgICAgICAgW3RpdGxlXT1cInNob3dIaWRlVGV4dCQgfCBhc3luY1wiXG4gICAgICAgICAgICAgICAgKGNsaWNrKT1cInRvZ2dsZShpdGVtKVwiXG4gICAgICAgICAgICAgICAgKGtleWRvd24uYXJyb3dEb3duLnByZXZlbnQpPVwibW92ZShpbmRleCwgMSlcIlxuICAgICAgICAgICAgICAgIChrZXlkb3duLmFycm93VXAucHJldmVudCk9XCJtb3ZlKGluZGV4LCAtMSlcIlxuICAgICAgICAgICAgPjwvYnV0dG9uPlxuICAgICAgICA8L2Rpdj5cbiAgICA8L3R1aS10aWxlPlxuPC90dWktdGlsZXM+XG4iXX0=